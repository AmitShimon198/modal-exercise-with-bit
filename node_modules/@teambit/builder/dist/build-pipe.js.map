{"version":3,"sources":["build-pipe.ts"],"names":["BuildPipe","constructor","tasksQueue","envsBuildContext","logger","artifactFactory","execute","executePreBuild","longProcessLogger","createLongProcessLogger","length","task","env","executeTask","end","tasksResultsList","TaskResultsList","taskResults","executePostBuild","setStatusLine","preBuild","getBuildContext","id","consoleSuccess","taskId","BuildTaskHelper","serializeId","taskName","description","logProgress","updateFailedDependencyTask","shouldSkipTask","startTask","process","hrtime","taskStartTime","Date","now","buildContext","buildTaskResult","endTime","compsWithErrors","componentsResults","filter","c","errors","artifacts","consoleFailure","failedTasks","push","duration","defs","generate","startTime","tasksResults","postBuild","failedDependencyTask","dependencies","forEach","dependency","aspectId","name","deserializeId","find","failedTask","envId","failedTaskId","consoleWarning","Error","previousTasksResults","from"],"mappings":"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","sourcesContent":["import { EnvDefinition } from '@teambit/envs';\nimport { ComponentMap } from '@teambit/component';\nimport { Logger, LongProcessLogger } from '@teambit/logger';\nimport mapSeries from 'p-map-series';\nimport prettyTime from 'pretty-time';\nimport { ArtifactFactory, ArtifactList } from './artifact';\nimport { BuildTask, BuildTaskHelper } from './build-task';\nimport { ComponentResult } from './types';\nimport { TasksQueue } from './tasks-queue';\nimport { EnvsBuildContext } from './builder.service';\nimport { TaskResultsList } from './task-results-list';\n\nexport type TaskResults = {\n  /**\n   * task itself. useful for getting its id/description later on.\n   */\n  task: BuildTask;\n\n  /**\n   * environment were the task was running\n   */\n  env: EnvDefinition;\n\n  /**\n   * component build results.\n   */\n  componentsResults: ComponentResult[];\n\n  /**\n   * artifacts generated by the build pipeline.\n   * in case the task finished with errors, this prop is undefined.\n   */\n  artifacts: ComponentMap<ArtifactList> | undefined;\n\n  /**\n   * timestamp of start initiation.\n   */\n  startTime: number;\n\n  /**\n   * timestamp of task completion.\n   */\n  endTime: number;\n};\n\nexport class BuildPipe {\n  private failedTasks: BuildTask[] = [];\n  private failedDependencyTask: BuildTask | undefined;\n  private longProcessLogger: LongProcessLogger;\n  private taskResults: TaskResults[] = [];\n  constructor(\n    /**\n     * array of services to apply on the components.\n     */\n    readonly tasksQueue: TasksQueue,\n    readonly envsBuildContext: EnvsBuildContext,\n    readonly logger: Logger,\n    readonly artifactFactory: ArtifactFactory\n  ) {}\n\n  /**\n   * execute a pipeline of build tasks.\n   */\n  async execute(): Promise<TaskResultsList> {\n    await this.executePreBuild();\n    this.longProcessLogger = this.logger.createLongProcessLogger('running tasks', this.tasksQueue.length);\n    await mapSeries(this.tasksQueue, async ({ task, env }) => this.executeTask(task, env));\n    this.longProcessLogger.end();\n    const tasksResultsList = new TaskResultsList(this.tasksQueue, this.taskResults);\n    await this.executePostBuild(tasksResultsList);\n\n    return tasksResultsList;\n  }\n\n  private async executePreBuild() {\n    this.logger.setStatusLine('executing pre-build for all tasks');\n    await mapSeries(this.tasksQueue, async ({ task, env }) => {\n      if (!task.preBuild) return;\n      await task.preBuild(this.getBuildContext(env.id));\n    });\n    this.logger.consoleSuccess();\n  }\n\n  private async executeTask(task: BuildTask, env: EnvDefinition): Promise<void> {\n    const taskId = BuildTaskHelper.serializeId(task);\n    const taskName = `${taskId}${task.description ? ` (${task.description})` : ''}`;\n    this.longProcessLogger.logProgress(`env \"${env.id}\", task \"${taskName}\"`);\n    this.updateFailedDependencyTask(task);\n    if (this.shouldSkipTask(taskId, env.id)) {\n      return;\n    }\n    const startTask = process.hrtime();\n    const taskStartTime = Date.now();\n    const buildContext = this.getBuildContext(env.id);\n    const buildTaskResult = await task.execute(buildContext);\n    const endTime = Date.now();\n    const compsWithErrors = buildTaskResult.componentsResults.filter((c) => c.errors?.length);\n    let artifacts;\n    if (compsWithErrors.length) {\n      this.logger.consoleFailure(`env: ${env.id}, task \"${taskId}\" has failed`);\n      this.failedTasks.push(task);\n    } else {\n      const duration = prettyTime(process.hrtime(startTask));\n      this.logger.consoleSuccess(`env \"${env.id}\", task \"${taskName}\" has completed successfully in ${duration}`);\n      const defs = buildTaskResult.artifacts || [];\n      artifacts = this.artifactFactory.generate(buildContext, defs, task);\n    }\n\n    const taskResults: TaskResults = {\n      task,\n      env,\n      componentsResults: buildTaskResult.componentsResults,\n      artifacts,\n      startTime: taskStartTime,\n      endTime,\n    };\n\n    this.taskResults.push(taskResults);\n  }\n\n  private async executePostBuild(tasksResults: TaskResultsList) {\n    this.logger.setStatusLine('executing post-build for all tasks');\n    await mapSeries(this.tasksQueue, async ({ task, env }) => {\n      if (!task.postBuild) return;\n      await task.postBuild(this.getBuildContext(env.id), tasksResults);\n    });\n    this.logger.consoleSuccess();\n  }\n\n  private updateFailedDependencyTask(task: BuildTask) {\n    if (!this.failedDependencyTask && this.failedTasks.length && task.dependencies) {\n      task.dependencies.forEach((dependency) => {\n        const { aspectId, name } = BuildTaskHelper.deserializeId(dependency);\n        this.failedDependencyTask = this.failedTasks.find((failedTask) => {\n          if (name && name !== failedTask.name) return false;\n          return aspectId === failedTask.aspectId;\n        });\n      });\n    }\n  }\n\n  private shouldSkipTask(taskId: string, envId: string): boolean {\n    if (!this.failedDependencyTask) return false;\n    const failedTaskId = BuildTaskHelper.serializeId(this.failedDependencyTask);\n    this.logger.consoleWarning(`env: ${envId}, task \"${taskId}\" has skipped due to \"${failedTaskId}\" failure`);\n    return true;\n  }\n\n  private getBuildContext(envId: string) {\n    const buildContext = this.envsBuildContext[envId];\n    if (!buildContext) throw new Error(`unable to find buildContext for ${envId}`);\n    buildContext.previousTasksResults = this.taskResults;\n    return buildContext;\n  }\n\n  /**\n   * create a build pipe from an array of tasks.\n   */\n  static from(\n    tasksQueue: TasksQueue,\n    envsBuildContext: EnvsBuildContext,\n    logger: Logger,\n    artifactFactory: ArtifactFactory\n  ) {\n    return new BuildPipe(tasksQueue, envsBuildContext, logger, artifactFactory);\n  }\n}\n"]}