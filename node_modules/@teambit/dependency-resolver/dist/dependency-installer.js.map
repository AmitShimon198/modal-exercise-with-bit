{"version":3,"sources":["dependency-installer.ts"],"names":["DEFAULT_PM_INSTALL_OPTIONS","dedupe","copyPeerToRuntimeOnRoot","copyPeerToRuntimeOnComponents","DEFAULT_INSTALL_OPTIONS","installTeambitBit","DependencyInstaller","constructor","packageManager","aspectLoader","logger","rootDir","cacheRootDir","preInstallSubscriberList","postInstallSubscriberList","install","rootPolicy","componentDirectoryMap","options","packageManagerOptions","args","runPrePostSubscribers","mainAspect","finalRootDir","RootDirNotDefined","calculatedPmOpts","Object","assign","version","packageName","MainAspectNotInstallable","add","dependencyId","lifecycleType","value","cleanCompsNodeModules","promises","toArray","map","dir","nmDir","path","join","fs","remove","Promise","all","subscribers","type","message","setStatusLine","subscriber","consoleSuccess"],"mappings":"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","sourcesContent":["import mapSeries from 'p-map-series';\nimport path from 'path';\nimport fs from 'fs-extra';\nimport { MainAspect, AspectLoaderMain } from '@teambit/aspect-loader';\nimport { ComponentMap } from '@teambit/component';\nimport { Logger } from '@teambit/logger';\nimport { PathAbsolute } from '@teambit/legacy/dist/utils/path';\nimport { MainAspectNotInstallable, RootDirNotDefined } from './exceptions';\nimport { PackageManager, PackageManagerInstallOptions } from './package-manager';\nimport { WorkspacePolicy } from './policy';\n\nconst DEFAULT_PM_INSTALL_OPTIONS: PackageManagerInstallOptions = {\n  dedupe: true,\n  copyPeerToRuntimeOnRoot: true,\n  copyPeerToRuntimeOnComponents: false,\n};\n\nconst DEFAULT_INSTALL_OPTIONS: InstallOptions = {\n  installTeambitBit: false,\n};\n\ntype InstallArgs = {\n  rootDir: string | undefined;\n  rootPolicy: WorkspacePolicy;\n  componentDirectoryMap: ComponentMap<string>;\n  options: InstallOptions;\n  packageManagerOptions: PackageManagerInstallOptions;\n};\n\nexport type InstallOptions = {\n  installTeambitBit: boolean;\n};\n\nexport type PreInstallSubscriber = (installer: DependencyInstaller, installArgs: InstallArgs) => Promise<void>;\nexport type PreInstallSubscriberList = Array<PreInstallSubscriber>;\n\nexport type PostInstallSubscriber = (installer: DependencyInstaller, installArgs: InstallArgs) => Promise<void>;\nexport type PostInstallSubscriberList = Array<PostInstallSubscriber>;\n\nexport class DependencyInstaller {\n  constructor(\n    /**\n     * package manager instance.\n     */\n    private packageManager: PackageManager,\n\n    private aspectLoader: AspectLoaderMain,\n\n    private logger: Logger,\n\n    private rootDir?: string | PathAbsolute,\n\n    private cacheRootDir?: string | PathAbsolute,\n\n    private preInstallSubscriberList?: PreInstallSubscriberList,\n\n    private postInstallSubscriberList?: PostInstallSubscriberList\n  ) {}\n\n  async install(\n    rootDir: string | undefined,\n    rootPolicy: WorkspacePolicy,\n    componentDirectoryMap: ComponentMap<string>,\n    options: InstallOptions = DEFAULT_INSTALL_OPTIONS,\n    packageManagerOptions: PackageManagerInstallOptions = DEFAULT_PM_INSTALL_OPTIONS\n  ) {\n    const args = {\n      componentDirectoryMap,\n      options,\n      packageManagerOptions,\n      rootDir,\n      rootPolicy,\n    };\n    await this.runPrePostSubscribers(this.preInstallSubscriberList, 'pre', args);\n    const mainAspect: MainAspect = this.aspectLoader.mainAspect;\n    const finalRootDir = rootDir || this.rootDir;\n    if (!finalRootDir) {\n      throw new RootDirNotDefined();\n    }\n    // Make sure to take other default if passed options with only one option\n    const calculatedPmOpts = Object.assign(\n      {},\n      DEFAULT_PM_INSTALL_OPTIONS,\n      { cacheRootDir: this.cacheRootDir },\n      packageManagerOptions\n    );\n    if (options.installTeambitBit) {\n      if (!mainAspect.version || !mainAspect.packageName) {\n        throw new MainAspectNotInstallable();\n      }\n      const version = mainAspect.version;\n      rootPolicy.add({\n        dependencyId: mainAspect.packageName,\n        lifecycleType: 'runtime',\n        value: {\n          version,\n        },\n      });\n    }\n\n    // remove node modules dir for all components dirs, since it might contain left overs from previous install\n    await this.cleanCompsNodeModules(componentDirectoryMap);\n\n    // TODO: the cache should be probably passed to the package manager constructor not to the install function\n    await this.packageManager.install(finalRootDir, rootPolicy, componentDirectoryMap, calculatedPmOpts);\n    await this.runPrePostSubscribers(this.postInstallSubscriberList, 'post', args);\n    return componentDirectoryMap;\n  }\n\n  private async cleanCompsNodeModules(componentDirectoryMap: ComponentMap<string>) {\n    const promises = componentDirectoryMap.toArray().map(([, dir]) => {\n      const nmDir = path.join(dir, 'node_modules');\n      return fs.remove(nmDir);\n    });\n    return Promise.all(promises);\n  }\n\n  private async runPrePostSubscribers(\n    subscribers: PreInstallSubscriberList | PostInstallSubscriberList = [],\n    type: 'pre' | 'post',\n    args: InstallArgs\n  ): Promise<void> {\n    let message = 'running pre install subscribers';\n    if (type === 'post') {\n      message = 'running post install subscribers';\n    }\n    this.logger.setStatusLine(message);\n    await mapSeries(subscribers, async (subscriber) => {\n      return subscriber(this, args);\n    });\n    this.logger.consoleSuccess(message);\n  }\n}\n"]}