{"version":3,"sources":["dependency-resolver.main.runtime.ts"],"names":["BIT_DEV_REGISTRY","NPM_REGISTRY","defaultLinkingOptions","legacyLink","linkTeambitBit","linkCoreAspects","defaultCreateFromComponentsOptions","filterComponentsFromManifests","createManifestForComponentsWithoutDependencies","DependencyResolverMain","constructor","config","rootPolicyRegistry","policiesRegistry","envs","logger","configAspect","aspectLoader","globalConfig","componentAspect","packageManagerSlot","dependencyFactorySlot","preInstallSlot","postInstallSlot","registerPackageManager","packageManager","register","registerDependencyFactories","factories","registerPreInstallSubscribers","subscribers","registerPostInstallSubscribers","getSavePrefix","savePrefix","getVersionWithSavePrefix","version","overridePrefix","prefix","versionWithPrefix","semver","validRange","InvalidVersionWithPrefix","getPolicy","component","entry","state","aspects","get","DependencyResolverAspect","id","factory","VariantPolicyFactory","getEmpty","serializedPolicy","parse","extractDepsFromLegacy","policy","componentPolicy","legacyComponent","_consumer","listFactory","getDependencyListFactory","dependencyList","fromLegacyComponent","forEach","dep","found","find","source","serialize","values","flat","factoriesMap","reduce","acc","type","DependencyListFactory","getDependencies","DependencyList","fromArray","serializedDependencies","data","dependencies","getDependenciesFromSerializedDependencies","length","deps","fromSerializedDependencies","getWorkspacePolicy","policyFromConfig","getWorkspacePolicyFromConfig","externalPolicies","toArray","map","mergeWorkspacePolices","WorkspacePolicyFactory","fromConfigObject","getWorkspacePolicyFromPackageJson","packageJson","fromPackageJson","polices","WorkspacePolicy","mergePolices","getWorkspaceManifest","name","ROOT_NAME","SemVer","rootPolicy","rootDir","components","options","setStatusLine","concreteOpts","workspaceManifestFactory","WorkspaceManifestFactory","res","createFromComponents","consoleSuccess","getInstaller","packageManagerName","cacheRootDir","cacheRootDirectory","getSync","CFG_PACKAGE_MANAGER_CACHE","PackageManagerNotFound","fs","pathExistsSync","debug","ensureDirSync","preInstallSubscribers","getPreInstallSubscribers","postInstallSubscribers","getPostInstallSubscribers","DependencyInstaller","getLinker","linkingOptions","Object","assign","DependencyLinker","getPackageManagerName","getVersionResolver","DependencyVersionResolver","getSystemPackageManager","defaultPm","Error","getProxyConfig","proxyConfigFromDepResolverConfig","getProxyConfigFromDepResolverConfig","httpProxy","httpsProxy","proxyConfigFromPackageManager","getProxyConfigFromPackageManager","proxyConfigFromGlobalConfig","getProxyConfigFromGlobalConfig","ca","cert","proxy","key","noProxy","strictSSL","strictSsl","toLowerCase","systemPm","Http","getRegistries","registries","bitScope","scopes","bit","getDefaultBitRegistry","bitRegistry","uri","bitOriginalAuthType","bitAuthHeaderValue","bitOriginalAuthValue","getBitAuthConfig","alwaysAuth","undefined","bitDefaultRegistry","Registry","installFromBitDevRegistry","defaultRegistry","startsWith","setDefaultRegistry","updateScopedRegistry","addAuthToScopedBitRegistries","bitScopeRegistry","updatedRegistries","entries","registry","authHeaderValue","includes","registryWithAuth","bitGlobalConfigToken","CFG_USER_TOKEN_KEY","originalAuthType","originalAuthValue","addToRootPolicy","workspacePolicy","add","workspacePolicyObject","toConfigObject","setExtension","overrideExisting","ignoreVersion","persistConfig","workspaceDir","workspaceConfig","write","dir","registerDependenciesPolicies","registerRootPolicy","mergeVariantPolicies","configuredExtensions","variantPolicyFactory","policiesFromEnv","policiesFromSlots","policiesFromConfig","env","calculateEnvFromExtensions","policiesFromEnvConfig","configuredIds","ids","policiesTuples","extId","policyTupleToApply","policyRegistrar","currentPolicy","VariantPolicy","currentExtension","findExtension","currentConfig","result","updateDepsOnLegacyTag","idTransformer","extensions","findCoreExtension","__type","COMPONENT_DEP_TYPE","depId","BitId","componentId","newDepId","toString","updateDepsOnLegacyExport","registerDetector","detector","DetectorHook","hooks","push","onLoadRequireableExtensionSubscriber","requireableExtension","manifest","parentComponent","resolveRequireableExtensionManifestDepsVersionsRecursively","resolvedParentComponent","resolvedParentDeps","updateDirectDepsVersions","isCoreAspect","parentComponentId","getHost","resolveComponentId","error","resolvedDep","findDependency","_runtimes","runtime","provider","loggerExt","configMain","graphql","createLogger","dependencyResolver","registerShowFragments","DependenciesFragment","DevDependenciesFragment","PeerDependenciesFragment","ComponentDependencyFactory","DependencyResolver","getDepResolverAspectName","LegacyComponent","registerOnComponentOverridesLoading","toLegacyDepsOverrides","registerWorkspacePolicyGetter","toManifest","bind","registerOnLoadRequireableExtensionSlot","getEmptyDepsObject","devDependencies","peerDependencies","MainRuntime","EnvsAspect","LoggerAspect","ConfigAspect","AspectLoaderAspect","ComponentAspect","GraphqlAspect","GlobalConfigAspect","Slot","withType","packageManagerArgs","devFilePatterns","strictPeerDependencies","addRuntime"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAGA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAIA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAKA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAMA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAaA;AAAA;;AAAA;AAAA;AAAA;;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","sourcesContent":["import mapSeries from 'p-map-series';\nimport { MainRuntime } from '@teambit/cli';\nimport ComponentAspect, { Component, ComponentMain } from '@teambit/component';\nimport type { Config } from '@teambit/config';\nimport { get } from 'lodash';\nimport { ConfigAspect } from '@teambit/config';\nimport { EnvsAspect, EnvsMain } from '@teambit/envs';\nimport { Slot, SlotRegistry, ExtensionManifest, Aspect, RuntimeManifest } from '@teambit/harmony';\nimport { RequireableComponent } from '@teambit/harmony.modules.requireable-component';\nimport type { LoggerMain } from '@teambit/logger';\nimport { GraphqlAspect, GraphqlMain } from '@teambit/graphql';\nimport { Logger, LoggerAspect } from '@teambit/logger';\nimport { CFG_PACKAGE_MANAGER_CACHE, CFG_USER_TOKEN_KEY } from '@teambit/legacy/dist/constants';\n// TODO: it's weird we take it from here.. think about it../workspace/utils\nimport { DependencyResolver } from '@teambit/legacy/dist/consumer/component/dependencies/dependency-resolver';\nimport { ExtensionDataList } from '@teambit/legacy/dist/consumer/config/extension-data';\nimport { DetectorHook } from '@teambit/legacy/dist/consumer/component/dependencies/files-dependency-builder/detector-hook';\nimport { Http, ProxyConfig } from '@teambit/legacy/dist/scope/network/http';\nimport {\n  registerUpdateDependenciesOnTag,\n  onTagIdTransformer,\n} from '@teambit/legacy/dist/scope/component-ops/tag-model-component';\nimport {\n  registerUpdateDependenciesOnExport,\n  OnExportIdTransformer,\n} from '@teambit/legacy/dist/scope/component-ops/export-scope-components';\nimport { Version as VersionModel } from '@teambit/legacy/dist/scope/models';\nimport LegacyComponent from '@teambit/legacy/dist/consumer/component';\nimport fs from 'fs-extra';\nimport { BitId } from '@teambit/legacy-bit-id';\nimport semver, { SemVer } from 'semver';\nimport AspectLoaderAspect, { AspectLoaderMain } from '@teambit/aspect-loader';\nimport GlobalConfigAspect, { GlobalConfigMain } from '@teambit/global-config';\nimport { Registries, Registry } from './registry';\nimport { ROOT_NAME } from './dependencies/constants';\nimport { DependencyInstaller, PreInstallSubscriberList, PostInstallSubscriberList } from './dependency-installer';\nimport { DependencyResolverAspect } from './dependency-resolver.aspect';\nimport { DependencyVersionResolver } from './dependency-version-resolver';\nimport { DependencyLinker, LinkingOptions } from './dependency-linker';\nimport { InvalidVersionWithPrefix, PackageManagerNotFound } from './exceptions';\nimport {\n  CreateFromComponentsOptions,\n  WorkspaceManifest,\n  WorkspaceManifestFactory,\n  ManifestDependenciesObject,\n} from './manifest';\nimport {\n  WorkspacePolicyConfigObject,\n  VariantPolicyConfigObject,\n  WorkspacePolicy,\n  WorkspacePolicyFactory,\n  VariantPolicy,\n  VariantPolicyFactory,\n  WorkspacePolicyAddEntryOptions,\n  WorkspacePolicyEntry,\n  SerializedVariantPolicy,\n} from './policy';\nimport { PackageManager } from './package-manager';\n\nimport {\n  SerializedDependency,\n  DependencyListFactory,\n  DependencyFactory,\n  ComponentDependencyFactory,\n  COMPONENT_DEP_TYPE,\n  DependencyList,\n} from './dependencies';\nimport { DependenciesFragment, DevDependenciesFragment, PeerDependenciesFragment } from './show-fragments';\nimport { dependencyResolverSchema } from './dependency-resolver.graphql';\nimport { DependencyDetector } from './dependency-detector';\n\nexport const BIT_DEV_REGISTRY = 'https://node.bit.dev/';\nexport const NPM_REGISTRY = 'https://registry.npmjs.org/';\n\nexport { ProxyConfig } from '@teambit/legacy/dist/scope/network/http';\n\nexport interface DependencyResolverWorkspaceConfig {\n  policy: WorkspacePolicyConfigObject;\n  /**\n   * choose the package manager for Bit to use. you can choose between 'npm', 'yarn', 'pnpm'\n   * and 'librarian'. our recommendation is use 'librarian' which reduces package duplicates\n   * and totally removes the need of a 'node_modules' directory in your project.\n   */\n  packageManager: string;\n\n  /**\n   * A proxy server for out going network requests by the package manager\n   * Used for both http and https requests (unless the httpsProxy is defined)\n   */\n  proxy?: string;\n\n  /**\n   * A proxy server for outgoing https requests by the package manager (fallback to proxy server if not defined)\n   * Use this in case you want different proxy for http and https requests.\n   */\n  httpsProxy?: string;\n\n  /**\n   * A path to a file containing one or multiple Certificate Authority signing certificates.\n   * allows for multiple CA's, as well as for the CA information to be stored in a file on disk.\n   */\n  ca?: string;\n\n  /**\n   * Whether or not to do SSL key validation when making requests to the registry via https\n   */\n  strictSsl?: string;\n\n  /**\n   * A client certificate to pass when accessing the registry. Values should be in PEM format (Windows calls it \"Base-64 encoded X.509 (.CER)\") with newlines replaced by the string \"\\n\". For example:\n   * cert=\"-----BEGIN CERTIFICATE-----\\nXXXX\\nXXXX\\n-----END CERTIFICATE-----\"\n   * It is not the path to a certificate file (and there is no \"certfile\" option).\n   */\n  cert?: string;\n\n  /**\n   * A client key to pass when accessing the registry. Values should be in PEM format with newlines replaced by the string \"\\n\". For example:\n   * key=\"-----BEGIN PRIVATE KEY-----\\nXXXX\\nXXXX\\n-----END PRIVATE KEY-----\"\n   * It is not the path to a key file (and there is no \"keyfile\" option).\n   */\n  key?: string;\n\n  /**\n   * A comma-separated string of domain extensions that a proxy should not be used for.\n   */\n  noProxy?: string;\n\n  /**\n   * If true, then Bit will add the \"--strict-peer-dependencies\" option when invoking package managers.\n   * This causes \"bit install\" to fail if there are unsatisfied peer dependencies, which is\n   * an invalid state that can cause build failures or incompatible dependency versions.\n   * (For historical reasons, JavaScript package managers generally do not treat this invalid\n   * state as an error.)\n   *\n   * The default value is false to avoid legacy compatibility issues.\n   * It is strongly recommended to set strictPeerDependencies=true.\n   */\n  strictPeerDependencies: boolean;\n  /**\n   * map of extra arguments to pass to the configured package manager upon the installation\n   * of dependencies.\n   */\n  packageManagerArgs: string[];\n\n  /**\n   * regex to determine whether a file is a file meant for development purposes.\n   */\n  devFilePatterns: string[];\n\n  /**\n   * By default when bit see your default registry in your npmrc is set to 'https://registry.npmjs.org/'\n   * bit will replace it with the bit.dev npm registry (node.bit.dev) during bit install\n   * bit does this in order to save you the need to configure many scoped registries for components from different owners\n   * bit.dev registry will then proxy the request to npmjs registry for non found packages in the bit.dev registry.\n   * in case you want to disable this proxy set this config to false\n   *\n   */\n  installFromBitDevRegistry: boolean;\n\n  /**\n   * Like https://docs.npmjs.com/cli/v7/using-npm/config#save-prefix\n   * Set the prefix to use when adding dependency to workspace.jsonc via bit install\n   * to lock version to exact version you can use empty string (default)\n   */\n  savePrefix: string;\n}\n\nexport interface DependencyResolverVariantConfig {\n  policy: VariantPolicyConfigObject;\n}\n\nexport type RootPolicyRegistry = SlotRegistry<WorkspacePolicy>;\nexport type PoliciesRegistry = SlotRegistry<VariantPolicyConfigObject>;\nexport type PackageManagerSlot = SlotRegistry<PackageManager>;\nexport type DependencyFactorySlot = SlotRegistry<DependencyFactory[]>;\nexport type PreInstallSlot = SlotRegistry<PreInstallSubscriberList>;\nexport type PostInstallSlot = SlotRegistry<PostInstallSubscriberList>;\n\nexport type MergeDependenciesFunc = (configuredExtensions: ExtensionDataList) => Promise<VariantPolicyConfigObject>;\n\nexport type GetInstallerOptions = {\n  rootDir?: string;\n  packageManager?: string;\n  cacheRootDirectory?: string;\n};\n\nexport type GetLinkerOptions = {\n  rootDir?: string;\n  linkingOptions?: LinkingOptions;\n};\n\nexport type GetVersionResolverOptions = {\n  cacheRootDirectory?: string;\n};\n\nconst defaultLinkingOptions: LinkingOptions = {\n  legacyLink: true,\n  linkTeambitBit: true,\n  linkCoreAspects: true,\n};\n\nconst defaultCreateFromComponentsOptions: CreateFromComponentsOptions = {\n  filterComponentsFromManifests: true,\n  createManifestForComponentsWithoutDependencies: true,\n};\n\nexport class DependencyResolverMain {\n  constructor(\n    /**\n     * Dependency resolver  extension configuration.\n     */\n    readonly config: DependencyResolverWorkspaceConfig,\n\n    /**\n     * Registry for changes by other extensions.\n     */\n    private rootPolicyRegistry: RootPolicyRegistry,\n\n    /**\n     * Registry for changes by other extensions.\n     */\n    private policiesRegistry: PoliciesRegistry,\n\n    /**\n     * envs extension.\n     */\n    private envs: EnvsMain,\n\n    private logger: Logger,\n\n    private configAspect: Config,\n\n    private aspectLoader: AspectLoaderMain,\n\n    private globalConfig: GlobalConfigMain,\n\n    /**\n     * component aspect.\n     */\n    readonly componentAspect: ComponentMain,\n\n    private packageManagerSlot: PackageManagerSlot,\n\n    private dependencyFactorySlot: DependencyFactorySlot,\n\n    private preInstallSlot: PreInstallSlot,\n\n    private postInstallSlot: PostInstallSlot\n  ) {}\n\n  /**\n   * register a new package manager to the dependency resolver.\n   */\n  registerPackageManager(packageManager: PackageManager) {\n    this.packageManagerSlot.register(packageManager);\n  }\n\n  registerDependencyFactories(factories: DependencyFactory[]) {\n    this.dependencyFactorySlot.register(factories);\n  }\n\n  registerPreInstallSubscribers(subscribers: PreInstallSubscriberList) {\n    this.preInstallSlot.register(subscribers);\n  }\n\n  registerPostInstallSubscribers(subscribers: PreInstallSubscriberList) {\n    this.postInstallSlot.register(subscribers);\n  }\n\n  getSavePrefix(): string {\n    return this.config.savePrefix;\n  }\n\n  getVersionWithSavePrefix(version: string, overridePrefix?: string): string {\n    const prefix = overridePrefix || this.getSavePrefix() || '';\n    const versionWithPrefix = `${prefix}${version}`;\n    if (!semver.validRange(versionWithPrefix)) {\n      throw new InvalidVersionWithPrefix(versionWithPrefix);\n    }\n    return versionWithPrefix;\n  }\n\n  async getPolicy(component: Component): Promise<VariantPolicy> {\n    const entry = component.state.aspects.get(DependencyResolverAspect.id);\n    const factory = new VariantPolicyFactory();\n    if (!entry) {\n      return factory.getEmpty();\n    }\n    const serializedPolicy: SerializedVariantPolicy = get(entry, ['data', 'policy'], []);\n    return factory.parse(serializedPolicy);\n  }\n\n  /**\n   * This function called on component load in order to calculate the dependencies based on the legacy (consumer) component\n   * and write them to the dependencyResolver data.\n   * Do not use this function for other purpose.\n   * If you want to get the component dependencies call getDependencies (which will give you the dependencies from the data itself)\n   * TODO: once we switch deps resolver <> workspace relation we should make it private\n   * TODO: once we switch deps resolver <> workspace relation we should remove the resolveId func here\n   * @param component\n   */\n  async extractDepsFromLegacy(component: Component, policy?: VariantPolicy): Promise<SerializedDependency[]> {\n    const componentPolicy = policy || (await this.getPolicy(component));\n    const legacyComponent: LegacyComponent = component.state._consumer;\n    const listFactory = this.getDependencyListFactory();\n    const dependencyList = await listFactory.fromLegacyComponent(legacyComponent);\n    dependencyList.forEach((dep) => {\n      const found = componentPolicy.find(dep.id);\n      // if no policy found, the dependency was auto-resolved from the source code\n      dep.source = found?.source || 'auto';\n    });\n    return dependencyList.serialize();\n  }\n\n  private getDependencyListFactory(): DependencyListFactory {\n    const factories = this.dependencyFactorySlot.values().flat();\n    const factoriesMap = factories.reduce((acc, factory) => {\n      acc[factory.type] = factory;\n      return acc;\n    }, {});\n    const listFactory = new DependencyListFactory(factoriesMap);\n    return listFactory;\n  }\n\n  /**\n   * Main function to get the dependency list of a given component\n   * @param component\n   */\n  async getDependencies(component: Component): Promise<DependencyList> {\n    const entry = component.state.aspects.get(DependencyResolverAspect.id);\n    if (!entry) {\n      return DependencyList.fromArray([]);\n    }\n    const serializedDependencies: SerializedDependency[] = entry?.data?.dependencies || [];\n    return this.getDependenciesFromSerializedDependencies(serializedDependencies);\n  }\n\n  private async getDependenciesFromSerializedDependencies(\n    dependencies: SerializedDependency[]\n  ): Promise<DependencyList> {\n    if (!dependencies.length) {\n      return DependencyList.fromArray([]);\n    }\n    const listFactory = this.getDependencyListFactory();\n    const deps = await listFactory.fromSerializedDependencies(dependencies);\n    return deps;\n  }\n\n  /**\n   * Getting the merged workspace policy (from dep resolver config and others like root package.json)\n   * @returns\n   */\n  getWorkspacePolicy(): WorkspacePolicy {\n    const policyFromConfig = this.getWorkspacePolicyFromConfig();\n    const externalPolicies = this.rootPolicyRegistry.toArray().map(([, policy]) => policy);\n    return this.mergeWorkspacePolices([policyFromConfig, ...externalPolicies]);\n  }\n\n  /**\n   * Getting the workspace policy as defined in the workspace.jsonc in the dependencyResolver aspect\n   * This will not take into account packages that defined in the package.json of the root for example\n   * in most cases you should use getWorkspacePolicy\n   * @returns\n   */\n  getWorkspacePolicyFromConfig(): WorkspacePolicy {\n    const factory = new WorkspacePolicyFactory();\n    return factory.fromConfigObject(this.config.policy);\n  }\n\n  getWorkspacePolicyFromPackageJson(packageJson: Record<string, any>): WorkspacePolicy {\n    const factory = new WorkspacePolicyFactory();\n    return factory.fromPackageJson(packageJson);\n  }\n\n  mergeWorkspacePolices(polices: WorkspacePolicy[]): WorkspacePolicy {\n    return WorkspacePolicy.mergePolices(polices);\n  }\n\n  /**\n   * Create a workspace manifest\n   * The term workspace here is not the same as \"bit workspace\" but a workspace that represent a shared root\n   * for installation of many components (sometime it might point to the workspace path)\n   * in other case it can be for example the capsules root dir\n   *\n   * @param {string} [name=ROOT_NAME]\n   * @param {SemVer} [version=new SemVer('1.0.0')]\n   * @param {ManifestDependenciesObject} dependencies\n   * @param {string} rootDir\n   * @param {Component[]} components\n   * @param {CreateFromComponentsOptions} [options={\n   *       filterComponentsFromManifests: true,\n   *       createManifestForComponentsWithoutDependencies: true,\n   *     }]\n   * @returns {WorkspaceManifest}\n   * @memberof DependencyResolverMain\n   */\n  async getWorkspaceManifest(\n    name: string = ROOT_NAME,\n    version: SemVer = new SemVer('1.0.0'),\n    rootPolicy: WorkspacePolicy,\n    rootDir: string,\n    components: Component[],\n    options: CreateFromComponentsOptions = defaultCreateFromComponentsOptions\n  ): Promise<WorkspaceManifest> {\n    this.logger.setStatusLine('deduping dependencies for installation');\n    const concreteOpts = { ...defaultCreateFromComponentsOptions, ...options };\n    const workspaceManifestFactory = new WorkspaceManifestFactory(this);\n    const res = await workspaceManifestFactory.createFromComponents(\n      name,\n      version,\n      rootPolicy,\n      rootDir,\n      components,\n      concreteOpts\n    );\n    this.logger.consoleSuccess();\n    return res;\n  }\n\n  /**\n   * get a component dependency installer.\n   */\n  getInstaller(options: GetInstallerOptions = {}) {\n    const packageManagerName = options.packageManager || this.config.packageManager;\n    const packageManager = this.packageManagerSlot.get(packageManagerName);\n    const cacheRootDir = options.cacheRootDirectory || this.globalConfig.getSync(CFG_PACKAGE_MANAGER_CACHE);\n\n    if (!packageManager) {\n      throw new PackageManagerNotFound(this.config.packageManager);\n    }\n\n    if (cacheRootDir && !fs.pathExistsSync(cacheRootDir)) {\n      this.logger.debug(`creating package manager cache dir at ${cacheRootDir}`);\n      fs.ensureDirSync(cacheRootDir);\n    }\n    const preInstallSubscribers = this.getPreInstallSubscribers();\n    const postInstallSubscribers = this.getPostInstallSubscribers();\n    // TODO: we should somehow pass the cache root dir to the package manager constructor\n    return new DependencyInstaller(\n      packageManager,\n      this.aspectLoader,\n      this.logger,\n      options.rootDir,\n      cacheRootDir,\n      preInstallSubscribers,\n      postInstallSubscribers\n    );\n  }\n\n  private getPreInstallSubscribers(): PreInstallSubscriberList {\n    return this.preInstallSlot.values().flat();\n  }\n\n  private getPostInstallSubscribers(): PostInstallSubscriberList {\n    return this.postInstallSlot.values().flat();\n  }\n\n  /**\n   * get a component dependency linker.\n   */\n  getLinker(options: GetLinkerOptions = {}) {\n    const linkingOptions = Object.assign({}, defaultLinkingOptions, options?.linkingOptions || {});\n    // TODO: we should somehow pass the cache root dir to the package manager constructor\n    return new DependencyLinker(\n      this,\n      this.aspectLoader,\n      this.componentAspect,\n      this.envs,\n      this.logger,\n      options.rootDir,\n      linkingOptions\n    );\n  }\n\n  getPackageManagerName() {\n    return this.config.packageManager;\n  }\n\n  getVersionResolver(options: GetVersionResolverOptions = {}) {\n    const packageManager = this.packageManagerSlot.get(this.config.packageManager);\n    const cacheRootDir = options.cacheRootDirectory || this.globalConfig.getSync(CFG_PACKAGE_MANAGER_CACHE);\n\n    if (!packageManager) {\n      throw new PackageManagerNotFound(this.config.packageManager);\n    }\n\n    if (cacheRootDir && !fs.pathExistsSync(cacheRootDir)) {\n      this.logger.debug(`creating package manager cache dir at ${cacheRootDir}`);\n      fs.ensureDirSync(cacheRootDir);\n    }\n    // TODO: we should somehow pass the cache root dir to the package manager constructor\n    return new DependencyVersionResolver(packageManager, cacheRootDir);\n  }\n\n  /**\n   * return the system configured package manager. by default pnpm.\n   */\n  getSystemPackageManager(): PackageManager {\n    const defaultPm = 'teambit.dependencies/pnpm';\n    const packageManager = this.packageManagerSlot.get(defaultPm);\n    if (!packageManager) throw new Error(`default package manager: ${defaultPm} was not found`);\n    return packageManager;\n  }\n\n  async getProxyConfig(): Promise<ProxyConfig> {\n    const proxyConfigFromDepResolverConfig = this.getProxyConfigFromDepResolverConfig();\n    let httpProxy = proxyConfigFromDepResolverConfig.httpProxy;\n    let httpsProxy = proxyConfigFromDepResolverConfig.httpsProxy;\n\n    // Take config from the aspect config if defined\n    if (httpProxy || httpsProxy) {\n      this.logger.debug(\n        `proxy config taken from the dep resolver config. proxy: ${httpProxy} httpsProxy: ${httpsProxy}`\n      );\n      return proxyConfigFromDepResolverConfig;\n    }\n\n    // Take config from the package manager (npmrc) config if defined\n    const proxyConfigFromPackageManager = await this.getProxyConfigFromPackageManager();\n    if (proxyConfigFromPackageManager?.httpProxy || proxyConfigFromPackageManager?.httpsProxy) {\n      this.logger.debug(\n        `proxy config taken from the package manager config (npmrc). proxy: ${proxyConfigFromPackageManager.httpProxy} httpsProxy: ${proxyConfigFromPackageManager.httpsProxy}`\n      );\n      return proxyConfigFromPackageManager;\n    }\n\n    // Take config from global bit config\n    const proxyConfigFromGlobalConfig = await this.getProxyConfigFromGlobalConfig();\n    httpProxy = proxyConfigFromGlobalConfig.httpProxy;\n    httpsProxy = proxyConfigFromGlobalConfig.httpsProxy;\n    if (httpProxy || httpsProxy) {\n      this.logger.debug(`proxy config taken from the global bit config. proxy: ${httpProxy} httpsProxy: ${httpsProxy}`);\n      return proxyConfigFromGlobalConfig;\n    }\n    return {};\n  }\n\n  private getProxyConfigFromDepResolverConfig(): ProxyConfig {\n    return {\n      ca: this.config.ca,\n      cert: this.config.cert,\n      httpProxy: this.config.proxy,\n      httpsProxy: this.config.httpsProxy || this.config.proxy,\n      key: this.config.key,\n      noProxy: this.config.noProxy,\n      strictSSL: this.config.strictSsl?.toLowerCase() === 'true',\n    };\n  }\n\n  private async getProxyConfigFromPackageManager(): Promise<ProxyConfig> {\n    const packageManager = this.packageManagerSlot.get(this.config.packageManager);\n    let proxyConfigFromPackageManager: ProxyConfig = {};\n    if (packageManager?.getProxyConfig && typeof packageManager?.getProxyConfig === 'function') {\n      proxyConfigFromPackageManager = await packageManager?.getProxyConfig();\n    } else {\n      const systemPm = this.getSystemPackageManager();\n      if (!systemPm.getProxyConfig) throw new Error('system package manager must implement `getProxyConfig()`');\n      proxyConfigFromPackageManager = await systemPm.getProxyConfig();\n    }\n    return proxyConfigFromPackageManager;\n  }\n\n  private async getProxyConfigFromGlobalConfig(): Promise<ProxyConfig> {\n    return Http.getProxyConfig();\n  }\n\n  async getRegistries(): Promise<Registries> {\n    const packageManager = this.packageManagerSlot.get(this.config.packageManager);\n    let registries;\n    if (packageManager?.getRegistries && typeof packageManager?.getRegistries === 'function') {\n      registries = await packageManager?.getRegistries();\n    } else {\n      const systemPm = this.getSystemPackageManager();\n      if (!systemPm.getRegistries) throw new Error('system package manager must implement `getRegistries()`');\n      registries = await systemPm.getRegistries();\n    }\n\n    const bitScope = registries.scopes.bit;\n\n    const getDefaultBitRegistry = (): Registry => {\n      const bitRegistry = bitScope?.uri || BIT_DEV_REGISTRY;\n\n      const { bitOriginalAuthType, bitAuthHeaderValue, bitOriginalAuthValue } = this.getBitAuthConfig(bitScope);\n\n      const alwaysAuth = bitAuthHeaderValue !== undefined;\n      const bitDefaultRegistry = new Registry(\n        bitRegistry,\n        alwaysAuth,\n        bitAuthHeaderValue,\n        bitOriginalAuthType,\n        bitOriginalAuthValue\n      );\n      return bitDefaultRegistry;\n    };\n\n    const bitDefaultRegistry = getDefaultBitRegistry();\n\n    // Override default registry to use bit registry in case npmjs is the default - bit registry will proxy it\n    // We check also NPM_REGISTRY.startsWith because the uri might not have the trailing / we have in NPM_REGISTRY\n    if (\n      this.config.installFromBitDevRegistry &&\n      (!registries.defaultRegistry.uri ||\n        registries.defaultRegistry.uri === NPM_REGISTRY ||\n        NPM_REGISTRY.startsWith(registries.defaultRegistry.uri))\n    ) {\n      // TODO: this will not handle cases where you have token for private npm registries stored on npmjs\n      // it should be handled by somehow in such case (default is npmjs and there is token for default) by sending the token of npmjs to the registry\n      // (for example by setting some special header in the request)\n      // then in the registry server it should be use it when proxies\n      registries = registries.setDefaultRegistry(bitDefaultRegistry);\n    }\n    // Make sure @bit scope is register with alwaysAuth\n    if (!bitScope || (bitScope && !bitScope.alwaysAuth)) {\n      registries = registries.updateScopedRegistry('bit', bitDefaultRegistry);\n    }\n\n    registries = this.addAuthToScopedBitRegistries(registries, bitScope);\n    return registries;\n  }\n\n  /**\n   * This will mutate any registry which point to BIT_DEV_REGISTRY to have the auth config from the @bit scoped registry or from the user.token in bit's config\n   */\n  private addAuthToScopedBitRegistries(registries: Registries, bitScopeRegistry: Registry): Registries {\n    const { bitOriginalAuthType, bitAuthHeaderValue, bitOriginalAuthValue } = this.getBitAuthConfig(bitScopeRegistry);\n    const alwaysAuth = bitAuthHeaderValue !== undefined;\n    let updatedRegistries = registries;\n    Object.entries(registries.scopes).map(([name, registry]) => {\n      if (!registry.authHeaderValue && BIT_DEV_REGISTRY.includes(registry.uri)) {\n        const registryWithAuth = new Registry(\n          registry.uri,\n          alwaysAuth,\n          bitAuthHeaderValue,\n          bitOriginalAuthType,\n          bitOriginalAuthValue\n        );\n        updatedRegistries = updatedRegistries.updateScopedRegistry(name, registryWithAuth);\n      }\n      return updatedRegistries;\n    });\n    return updatedRegistries;\n  }\n\n  private getBitAuthConfig(\n    bitScopeRegistry: Registry\n  ): Partial<{ bitOriginalAuthType: string; bitAuthHeaderValue: string; bitOriginalAuthValue: string }> {\n    const bitGlobalConfigToken = this.globalConfig.getSync(CFG_USER_TOKEN_KEY);\n    let bitAuthHeaderValue = bitScopeRegistry?.authHeaderValue;\n    let bitOriginalAuthType = bitScopeRegistry?.originalAuthType;\n    let bitOriginalAuthValue = bitScopeRegistry?.originalAuthValue;\n\n    // In case there is no auth configuration in the npmrc, but there is token in bit config, take it from the config\n    if ((!bitScopeRegistry || !bitScopeRegistry.authHeaderValue) && bitGlobalConfigToken) {\n      bitOriginalAuthType = 'authToken';\n      bitAuthHeaderValue = `Bearer ${bitGlobalConfigToken}`;\n      bitOriginalAuthValue = bitGlobalConfigToken;\n    }\n\n    return {\n      bitOriginalAuthType,\n      bitAuthHeaderValue,\n      bitOriginalAuthValue,\n    };\n  }\n\n  get packageManagerName(): string {\n    return this.config.packageManager;\n  }\n\n  addToRootPolicy(entries: WorkspacePolicyEntry[], options?: WorkspacePolicyAddEntryOptions): WorkspacePolicy {\n    const workspacePolicy = this.getWorkspacePolicyFromConfig();\n    entries.forEach((entry) => workspacePolicy.add(entry, options));\n    const workspacePolicyObject = workspacePolicy.toConfigObject();\n    this.config.policy = workspacePolicyObject;\n    this.configAspect.setExtension(DependencyResolverAspect.id, this.config, {\n      overrideExisting: true,\n      ignoreVersion: true,\n    });\n    return workspacePolicy;\n  }\n\n  async persistConfig(workspaceDir?: string) {\n    return this.configAspect.workspaceConfig?.write({ dir: workspaceDir });\n  }\n\n  /**\n   * register new dependencies policies\n   */\n  registerDependenciesPolicies(policy: VariantPolicyConfigObject): void {\n    return this.policiesRegistry.register(policy);\n  }\n\n  /**\n   * register new dependencies policies\n   */\n  registerRootPolicy(policy: WorkspacePolicy): void {\n    return this.rootPolicyRegistry.register(policy);\n  }\n\n  /**\n   * Merge the dependencies provided by:\n   * 1. envs configured in the component - via dependencies method\n   * 2. extensions that registered to the registerDependencyPolicy slot (and configured for the component)\n   * 3. props defined by the user (they are the strongest one)\n   * @param configuredExtensions\n   */\n  async mergeVariantPolicies(configuredExtensions: ExtensionDataList): Promise<VariantPolicy> {\n    const variantPolicyFactory = new VariantPolicyFactory();\n    let policiesFromEnv: VariantPolicy = variantPolicyFactory.getEmpty();\n    let policiesFromSlots: VariantPolicy = variantPolicyFactory.getEmpty();\n    let policiesFromConfig: VariantPolicy = variantPolicyFactory.getEmpty();\n    const env = this.envs.calculateEnvFromExtensions(configuredExtensions).env;\n    if (env.getDependencies && typeof env.getDependencies === 'function') {\n      const policiesFromEnvConfig = await env.getDependencies();\n      if (policiesFromEnvConfig) {\n        policiesFromEnv = variantPolicyFactory.fromConfigObject(policiesFromEnvConfig, 'env');\n      }\n    }\n    const configuredIds = configuredExtensions.ids;\n    const policiesTuples = this.policiesRegistry.toArray();\n    configuredIds.forEach((extId) => {\n      // TODO: change this way of search, once we have workspace as dep-resolver dependency\n      // we can use something like:\n      // const resolvedId = this.workspace.resolveComponentId(extId)\n      // const currentPolicy = this.policiesRegistry.get(resolvedId.toString());\n      // Only get props from configured extensions on this specific component\n      const policyTupleToApply = policiesTuples.find(([policyRegistrar]) => {\n        return policyRegistrar === extId || policyRegistrar.includes(extId);\n      });\n\n      if (policyTupleToApply && policyTupleToApply[1]) {\n        const currentPolicy = variantPolicyFactory.fromConfigObject(policyTupleToApply[1], 'slots');\n        policiesFromSlots = VariantPolicy.mergePolices([policiesFromSlots, currentPolicy]);\n      }\n    });\n    const currentExtension = configuredExtensions.findExtension(DependencyResolverAspect.id);\n    const currentConfig = currentExtension?.config as unknown as DependencyResolverVariantConfig;\n    if (currentConfig && currentConfig.policy) {\n      policiesFromConfig = variantPolicyFactory.fromConfigObject(currentConfig.policy, 'config');\n    }\n\n    const result = VariantPolicy.mergePolices([policiesFromEnv, policiesFromSlots, policiesFromConfig]);\n    return result;\n  }\n\n  updateDepsOnLegacyTag(component: LegacyComponent, idTransformer: onTagIdTransformer): LegacyComponent {\n    const entry = component.extensions.findCoreExtension(DependencyResolverAspect.id);\n    if (!entry) {\n      return component;\n    }\n    const dependencies = get(entry, ['data', 'dependencies'], []);\n    dependencies.forEach((dep) => {\n      if (dep.__type === COMPONENT_DEP_TYPE) {\n        const depId = new BitId(dep.componentId);\n        const newDepId = idTransformer(depId);\n        dep.componentId = (newDepId || depId).serialize();\n        dep.id = (newDepId || depId).toString();\n        dep.version = (newDepId || depId).version;\n      }\n    });\n    return component;\n  }\n\n  updateDepsOnLegacyExport(version: VersionModel, idTransformer: OnExportIdTransformer): VersionModel {\n    const entry = version.extensions.findCoreExtension(DependencyResolverAspect.id);\n    if (!entry) {\n      return version;\n    }\n    const dependencies = get(entry, ['data', 'dependencies'], []);\n    dependencies.forEach((dep) => {\n      if (dep.__type === COMPONENT_DEP_TYPE) {\n        const depId = new BitId(dep.componentId);\n        const newDepId = idTransformer(depId);\n        dep.componentId = (newDepId || depId).serialize();\n        dep.id = (newDepId || depId).toString();\n      }\n    });\n    return version;\n  }\n\n  /**\n   * Register a new dependency detector. Detectors allow to extend Bit's dependency detection\n   * mechanism to support new file extensions and types.\n   */\n  registerDetector(detector: DependencyDetector) {\n    DetectorHook.hooks.push(detector);\n    return this;\n  }\n\n  /**\n   * This function registered to the onLoadRequireableExtensionSlot of the aspect-loader\n   * Update the aspect / manifest deps versions in the runtimes (recursively)\n   * This function mutate the manifest directly as otherwise it becomes very complicated\n   * TODO: think if this funciton should be here as it about dependencies, or on the aspect loader\n   * (as it's aware of the internal structure of aspects)\n   * Maybe only register the dep resolution part to the aspect loader\n   * at the moment it here for simplify the process\n   * @param requireableExtension\n   * @param manifest\n   * @returns\n   */\n  async onLoadRequireableExtensionSubscriber(\n    requireableExtension: RequireableComponent,\n    manifest: ExtensionManifest | Aspect\n  ): Promise<ExtensionManifest | Aspect> {\n    const parentComponent = requireableExtension.component;\n    return this.resolveRequireableExtensionManifestDepsVersionsRecursively(parentComponent, manifest);\n  }\n\n  /**\n   * Update the aspect / manifest deps versions in the runtimes (recursively)\n   * @param parentComponent\n   * @param manifest\n   */\n  private async resolveRequireableExtensionManifestDepsVersionsRecursively(\n    // Allow getting here string for lazy load the component\n    // we only want to load the component in case there are deps to resolve\n    parentComponent: Component | string,\n    manifest: ExtensionManifest | Aspect\n    // TODO: add visited = new Map() for performence improve\n  ): Promise<ExtensionManifest | Aspect> {\n    // Not resolve it immediately for performance sake\n    let resolvedParentComponent: Component | undefined;\n    let resolvedParentDeps: DependencyList;\n    const updateDirectDepsVersions = (deps: Array<ExtensionManifest | Aspect>): Promise<void[]> => {\n      return mapSeries(deps, async (dep) => {\n        // Nothing to update (this shouldn't happen ever)\n        if (!dep.id) return;\n        // In case of core aspect, do not update the version, as it's loaded to harmony without version\n        if (this.aspectLoader.isCoreAspect(dep.id)) return;\n        // Lazily get the parent component\n        if (typeof parentComponent === 'string') {\n          const parentComponentId = await this.componentAspect.getHost().resolveComponentId(parentComponent);\n          resolvedParentComponent = await this.componentAspect.getHost().get(parentComponentId);\n        } else {\n          // it's of type component;\n          resolvedParentComponent = parentComponent;\n        }\n        if (!resolvedParentComponent) {\n          this.logger.error(\n            `could not resolve the component ${parentComponent} during manifest deps resolution. it shouldn't happen`\n          );\n          return;\n        }\n        // Lazily get the dependencies\n        resolvedParentDeps = resolvedParentDeps || (await this.getDependencies(resolvedParentComponent));\n        const resolvedDep = resolvedParentDeps.findDependency(dep.id, { ignoreVersion: true });\n        // TODO: add a way to update id in harmony\n        // @ts-ignore\n        dep.id = resolvedDep?.id ?? dep.id;\n        await this.resolveRequireableExtensionManifestDepsVersionsRecursively(dep.id, dep);\n      });\n    };\n    if (manifest.dependencies) {\n      await updateDirectDepsVersions(manifest.dependencies);\n    }\n    // TODO: add a function to get all runtimes and not access private member\n    // @ts-ignore\n    if (manifest._runtimes) {\n      // @ts-ignore\n      await mapSeries(manifest._runtimes, async (runtime: RuntimeManifest) => {\n        if (runtime.dependencies) {\n          await updateDirectDepsVersions(runtime.dependencies);\n        }\n      });\n    }\n    return manifest;\n  }\n\n  static runtime = MainRuntime;\n  static dependencies = [\n    EnvsAspect,\n    LoggerAspect,\n    ConfigAspect,\n    AspectLoaderAspect,\n    ComponentAspect,\n    GraphqlAspect,\n    GlobalConfigAspect,\n  ];\n\n  static slots = [\n    Slot.withType<WorkspacePolicy>(),\n    Slot.withType<VariantPolicyConfigObject>(),\n    Slot.withType<PackageManager>(),\n    Slot.withType<RegExp>(),\n    Slot.withType<DependencyFactory>(),\n    Slot.withType<PreInstallSubscriberList>(),\n    Slot.withType<PostInstallSubscriberList>(),\n    Slot.withType<DependencyDetector>(),\n  ];\n\n  static defaultConfig: DependencyResolverWorkspaceConfig = {\n    /**\n     * default package manager.\n     */\n    packageManager: 'teambit.dependencies/pnpm',\n    policy: {},\n    packageManagerArgs: [],\n    devFilePatterns: ['**/*.spec.ts'],\n    strictPeerDependencies: true,\n    installFromBitDevRegistry: true,\n    savePrefix: '',\n  };\n\n  static async provider(\n    [envs, loggerExt, configMain, aspectLoader, componentAspect, graphql, globalConfig]: [\n      EnvsMain,\n      LoggerMain,\n      Config,\n      AspectLoaderMain,\n      ComponentMain,\n      GraphqlMain,\n      GlobalConfigMain\n    ],\n    config: DependencyResolverWorkspaceConfig,\n    [\n      rootPolicyRegistry,\n      policiesRegistry,\n      packageManagerSlot,\n      dependencyFactorySlot,\n      preInstallSlot,\n      postInstallSlot,\n    ]: [\n      RootPolicyRegistry,\n      PoliciesRegistry,\n      PackageManagerSlot,\n      DependencyFactorySlot,\n      PreInstallSlot,\n      PostInstallSlot\n    ]\n  ) {\n    // const packageManager = new PackageManagerLegacy(config.packageManager, logger);\n    const logger = loggerExt.createLogger(DependencyResolverAspect.id);\n    const dependencyResolver = new DependencyResolverMain(\n      config,\n      rootPolicyRegistry,\n      policiesRegistry,\n      envs,\n      logger,\n      configMain,\n      aspectLoader,\n      globalConfig,\n      componentAspect,\n      packageManagerSlot,\n      dependencyFactorySlot,\n      preInstallSlot,\n      postInstallSlot\n    );\n\n    componentAspect.registerShowFragments([\n      new DependenciesFragment(dependencyResolver),\n      new DevDependenciesFragment(dependencyResolver),\n      new PeerDependenciesFragment(dependencyResolver),\n    ]);\n    // TODO: solve this generics issue and remove the ts-ignore\n    // @ts-ignore\n    dependencyResolver.registerDependencyFactories([new ComponentDependencyFactory(componentAspect)]);\n\n    DependencyResolver.getDepResolverAspectName = () => DependencyResolverAspect.id;\n\n    LegacyComponent.registerOnComponentOverridesLoading(\n      DependencyResolverAspect.id,\n      async (configuredExtensions: ExtensionDataList) => {\n        const policy = await dependencyResolver.mergeVariantPolicies(configuredExtensions);\n        return policy.toLegacyDepsOverrides();\n      }\n    );\n    DependencyResolver.registerWorkspacePolicyGetter(() => {\n      const workspacePolicy = dependencyResolver.getWorkspacePolicy();\n      return workspacePolicy.toManifest();\n    });\n    registerUpdateDependenciesOnTag(dependencyResolver.updateDepsOnLegacyTag.bind(dependencyResolver));\n    registerUpdateDependenciesOnExport(dependencyResolver.updateDepsOnLegacyExport.bind(dependencyResolver));\n    aspectLoader.registerOnLoadRequireableExtensionSlot(\n      dependencyResolver.onLoadRequireableExtensionSubscriber.bind(dependencyResolver)\n    );\n\n    graphql.register(dependencyResolverSchema(dependencyResolver));\n\n    return dependencyResolver;\n  }\n\n  getEmptyDepsObject(): ManifestDependenciesObject {\n    return {\n      dependencies: {},\n      devDependencies: {},\n      peerDependencies: {},\n    };\n  }\n}\n\nDependencyResolverAspect.addRuntime(DependencyResolverMain);\n"]}