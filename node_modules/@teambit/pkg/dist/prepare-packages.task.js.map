{"version":3,"sources":["prepare-packages.task.ts"],"names":["PreparePackagesTask","constructor","aspectId","logger","execute","context","result","componentsResults","executeDistAsRootTask","env","getCompiler","compilerInstance","distDir","Promise","all","capsuleNetwork","graphCapsules","map","capsule","removeSourceFiles","moveDistToRoot","updatePackageJson","excludeDirs","dir","excludeFiles","allFiles","getAllFilesPaths","ignore","debug","join","file","fs","remove","path","from","to","moveSync","compiler","distMainFile","getDistPathBySrcPath","component","state","_consumer","mainFile","distMainFileWithoutDistDir","replace","sep","packageJson","PackageJsonFile","loadFromCapsuleSync","addOrUpdateProperty","write"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AACA;AACA;AACO,MAAMA,mBAAN,CAA+C;AAGpDC,EAAAA,WAAW,CAAUC,QAAV,EAAoCC,MAApC,EAAoD;AAAA,SAA1CD,QAA0C,GAA1CA,QAA0C;AAAA,SAAhBC,MAAgB,GAAhBA,MAAgB;AAAA,kDAF/C,iBAE+C;AAAA,sDAD3C,KAC2C;AAAE,GAHb,CAKpD;;;AACa,QAAPC,OAAO,CAACC,OAAD,EAAkD;AAC7D,UAAMC,MAAM,GAAG;AACbC,MAAAA,iBAAiB,EAAE;AADN,KAAf;AAIA,WAAOD,MAAP;AACD;AAED;AACF;AACA;AACA;AACA;AACA;AACA;;;AACqC,QAArBE,qBAAqB,CAACH,OAAD,EAAwB;AACzD,QAAI,CAACA,OAAO,CAACI,GAAR,CAAYC,WAAjB,EAA8B;AAC9B,UAAMC,gBAA0B,GAAGN,OAAO,CAACI,GAAR,CAAYC,WAAZ,EAAnC;AACA,UAAME,OAAO,GAAGD,gBAAgB,CAACC,OAAjC;AAEA,UAAMC,OAAO,CAACC,GAAR,CACJT,OAAO,CAACU,cAAR,CAAuBC,aAAvB,CAAqCC,GAArC,CAAyC,MAAOC,OAAP,IAAmB;AAC1D,YAAM,KAAKC,iBAAL,CAAuBD,OAAvB,EAAgCN,OAAhC,CAAN;AACA,YAAM,KAAKQ,cAAL,CAAoBF,OAApB,EAA6BN,OAA7B,CAAN;AACA,YAAM,KAAKS,iBAAL,CAAuBH,OAAvB,EAAgCP,gBAAhC,EAAkDC,OAAlD,CAAN;AACD,KAJD,CADI,CAAN;AAOD;;AAE8B,QAAjBO,iBAAiB,CAACD,OAAD,EAAmBN,OAAnB,EAAoC;AACjE,UAAMU,WAAW,GAAG,CAACV,OAAD,EAAU,cAAV,EAA0B,QAA1B,EAAoC,KAApC,EAA2CK,GAA3C,CAAgDM,GAAD,IAAU,GAAEA,GAAI,KAA/D,CAApB;AACA,UAAMC,YAAY,GAAG,CAAC,cAAD,CAArB;AACA,UAAMC,QAAQ,GAAGP,OAAO,CAACQ,gBAAR,CAAyB,GAAzB,EAA8B;AAAEC,MAAAA,MAAM,EAAE,CAAC,GAAGL,WAAJ,EAAiB,GAAGE,YAApB;AAAV,KAA9B,CAAjB;AACA,SAAKrB,MAAL,CAAYyB,KAAZ,CAAmB,gCAA+BH,QAAQ,CAACI,IAAT,CAAc,IAAd,CAAoB,EAAtE;AACA,UAAMhB,OAAO,CAACC,GAAR,CAAYW,QAAQ,CAACR,GAAT,CAAca,IAAD,IAAUC,mBAAGC,MAAH,CAAUC,gBAAKJ,IAAL,CAAUX,OAAO,CAACe,IAAlB,EAAwBH,IAAxB,CAAV,CAAvB,CAAZ,CAAN;AACD;;AAE2B,QAAdV,cAAc,CAACF,OAAD,EAAmBN,OAAnB,EAAoC;AAC9D,UAAMsB,IAAI,GAAGD,gBAAKJ,IAAL,CAAUX,OAAO,CAACe,IAAlB,EAAwBrB,OAAxB,CAAb;;AACA,UAAMuB,EAAE,GAAGjB,OAAO,CAACe,IAAnB;AACA,SAAK9B,MAAL,CAAYyB,KAAZ,CAAmB,aAAYM,IAAK,QAAOC,EAAG,EAA9C,EAH8D,CAI9D;;AACAJ,uBAAGK,QAAH,CAAYF,IAAZ,EAAkBC,EAAlB;AACD;AAED;AACF;AACA;AACA;;;AACiC,QAAjBd,iBAAiB,CAACH,OAAD,EAAmBmB,QAAnB,EAAuCzB,OAAvC,EAAwD;AACrF,UAAM0B,YAAY,GAAGD,QAAQ,CAACE,oBAAT,CAA8BrB,OAAO,CAACsB,SAAR,CAAkBC,KAAlB,CAAwBC,SAAxB,CAAkCC,QAAhE,CAArB;AACA,UAAMC,0BAA0B,GAAGN,YAAY,CAACO,OAAb,CAAsB,GAAEjC,OAAQ,GAAEqB,gBAAKa,GAAI,EAA3C,EAA8C,EAA9C,CAAnC;;AACA,UAAMC,WAAW,GAAGC,2BAAgBC,mBAAhB,CAAoC/B,OAAO,CAACe,IAA5C,CAApB;;AACAc,IAAAA,WAAW,CAACG,mBAAZ,CAAgC,MAAhC,EAAwCN,0BAAxC;AACA,UAAMG,WAAW,CAACI,KAAZ,EAAN;AACD;;AA7DmD","sourcesContent":["import { BuildContext, BuiltTaskResult, BuildTask } from '@teambit/builder';\nimport { Compiler } from '@teambit/compiler';\nimport { Capsule } from '@teambit/isolator';\nimport { Logger } from '@teambit/logger';\nimport PackageJsonFile from '@teambit/legacy/dist/consumer/component/package-json-file';\nimport fs from 'fs-extra';\nimport path from 'path';\n\n/**\n * prepare packages for publishing.\n */\nexport class PreparePackagesTask implements BuildTask {\n  readonly name = 'PreparePackages';\n  readonly location = 'end';\n  constructor(readonly aspectId: string, private logger: Logger) {}\n\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  async execute(context: BuildContext): Promise<BuiltTaskResult> {\n    const result = {\n      componentsResults: [],\n    };\n\n    return result;\n  }\n\n  /**\n   * remove the source files and copy the dists files\n   * into the root of the capsule.\n   * this is needed when components import from other components internal paths. without this task,\n   * the internal paths are the source, so node will throw an error when trying to use them. this\n   * task makes sure that the internal paths point to the consumable code (dists).\n   */\n  private async executeDistAsRootTask(context: BuildContext) {\n    if (!context.env.getCompiler) return;\n    const compilerInstance: Compiler = context.env.getCompiler();\n    const distDir = compilerInstance.distDir;\n\n    await Promise.all(\n      context.capsuleNetwork.graphCapsules.map(async (capsule) => {\n        await this.removeSourceFiles(capsule, distDir);\n        await this.moveDistToRoot(capsule, distDir);\n        await this.updatePackageJson(capsule, compilerInstance, distDir);\n      })\n    );\n  }\n\n  private async removeSourceFiles(capsule: Capsule, distDir: string) {\n    const excludeDirs = [distDir, 'node_modules', 'public', 'bin'].map((dir) => `${dir}/**`);\n    const excludeFiles = ['package.json'];\n    const allFiles = capsule.getAllFilesPaths('.', { ignore: [...excludeDirs, ...excludeFiles] });\n    this.logger.debug(`delete the following files:\\n${allFiles.join('\\n')}`);\n    await Promise.all(allFiles.map((file) => fs.remove(path.join(capsule.path, file))));\n  }\n\n  private async moveDistToRoot(capsule: Capsule, distDir: string) {\n    const from = path.join(capsule.path, distDir);\n    const to = capsule.path;\n    this.logger.debug(`move from ${from} to: ${to}`);\n    // for some reason `fs.move` throws an error \"dest already exists.\".\n    fs.moveSync(from, to);\n  }\n\n  /**\n   * by default, the \"main\" prop points to the dist file (e.g. \"dist/index./js\").\n   * here, we have to change it because there is no dist dir anymore.\n   */\n  private async updatePackageJson(capsule: Capsule, compiler: Compiler, distDir: string) {\n    const distMainFile = compiler.getDistPathBySrcPath(capsule.component.state._consumer.mainFile);\n    const distMainFileWithoutDistDir = distMainFile.replace(`${distDir}${path.sep}`, '');\n    const packageJson = PackageJsonFile.loadFromCapsuleSync(capsule.path);\n    packageJson.addOrUpdateProperty('main', distMainFileWithoutDistDir);\n    await packageJson.write();\n  }\n}\n"]}