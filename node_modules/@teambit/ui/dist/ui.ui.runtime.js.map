{"version":3,"sources":["ui.ui.runtime.tsx"],"names":["UiUI","constructor","router","uiRootSlot","hudSlot","lifecycleSlot","element","register","render","rootExtension","rootFactory","getRoot","Error","uiRoot","initialLocation","window","location","pathname","search","hash","routes","renderRoutes","hudItems","values","lifecycleHooks","toArray","deserializedState","deserialize","renderContexts","triggerBrowserInit","reactContexts","getReactContexts","app","triggerBeforeHydrateHook","mountPoint","document","getElementById","mountPointId","ReactDOM","triggerHydrateHook","renderSsr","assets","browser","server","url","triggerServerInit","onBeforeRender","renderedApp","ReactDOMServer","renderToString","realtimeAssets","serialize","totalAssets","html","renderedHtml","renderToStaticMarkup","fullHtml","Html","fillContent","registerContext","context","reactContext","registerRoot","registerRenderHooks","hooks","Promise","all","map","idx","browserInit","serverInit","renderCtx","props","undefined","ctx","nextCtx","onBeforeHydrate","onHydrate","json","key","result","rawAssets","popAssets","deserialized","raw","get","e","console","error","provider","GraphqlUi","config","renderLifecycleSlot","uiUi","renderHooks","Slot","withType","GraphqlAspect","ReactRouterAspect","UIRuntime","UIAspect","addRuntime"],"mappings":"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","sourcesContent":["import type { GraphqlUI } from '@teambit/graphql';\nimport { GraphqlAspect } from '@teambit/graphql';\nimport { Slot, SlotRegistry } from '@teambit/harmony';\nimport type { ReactRouterUI } from '@teambit/react-router';\nimport { ReactRouterAspect } from '@teambit/react-router';\nimport { Html, MountPoint, mountPointId, ssrCleanup, Assets } from '@teambit/ui-foundation.ui.rendering.html';\n\nimport { merge } from 'webpack-merge';\nimport React, { ReactNode, ComponentType } from 'react';\nimport ReactDOM from 'react-dom';\nimport ReactDOMServer from 'react-dom/server';\nimport compact from 'lodash.compact';\n\nimport { Compose, Wrapper } from './compose';\nimport { UIRootFactory } from './ui-root.ui';\nimport { UIAspect, UIRuntime } from './ui.aspect';\nimport { ClientContext } from './ui/client-context';\nimport type { SsrContent } from './ssr/ssr-content';\nimport type { RequestServer } from './ssr/request-server';\nimport type { BrowserData } from './ssr/request-browser';\nimport { RenderLifecycle } from './render-lifecycle';\n\nexport type ContextProps<T = any> = { renderCtx?: T; children: ReactNode };\n\ntype HudSlot = SlotRegistry<ReactNode>;\ntype renderLifecycleSlot = SlotRegistry<RenderLifecycle>;\ntype UIRootRegistry = SlotRegistry<UIRootFactory>;\n\n/**\n * extension\n */\nexport class UiUI {\n  constructor(\n    /**\n     * react-router extension.\n     */\n    private router: ReactRouterUI,\n    /**\n     * ui root registry.\n     */\n    private uiRootSlot: UIRootRegistry,\n    /** slot for overlay ui elements */\n    private hudSlot: HudSlot,\n    /** hooks into the ssr render process */\n    private lifecycleSlot: renderLifecycleSlot\n  ) {}\n\n  /** render and rehydrate client-side */\n  async render(rootExtension: string): Promise<void> {\n    const rootFactory = this.getRoot(rootExtension);\n    if (!rootFactory) throw new Error(`root: ${rootExtension} was not found`);\n    const uiRoot = rootFactory();\n    const initialLocation = `${window.location.pathname}${window.location.search}${window.location.hash}`;\n    const routes = this.router.renderRoutes(uiRoot.routes, { initialLocation });\n    const hudItems = this.hudSlot.values();\n    const lifecycleHooks = this.lifecycleSlot.toArray();\n\n    // TODO - extract the logic from here down as reusable ssr machine\n    const deserializedState = await this.deserialize(lifecycleHooks);\n    let renderContexts = await this.triggerBrowserInit(lifecycleHooks, deserializedState);\n    const reactContexts = this.getReactContexts(lifecycleHooks, renderContexts);\n\n    const app = (\n      <Compose components={reactContexts}>\n        <ClientContext>\n          {hudItems}\n          {routes}\n        </ClientContext>\n      </Compose>\n    );\n\n    renderContexts = await this.triggerBeforeHydrateHook(renderContexts, lifecycleHooks, app);\n\n    const mountPoint = document.getElementById(mountPointId);\n    // .render() already runs `.hydrate()` behind the scenes.\n    // in the future, we may want to replace it with .hydrate()\n    ReactDOM.render(app, mountPoint);\n\n    await this.triggerHydrateHook(renderContexts, lifecycleHooks, mountPoint);\n\n    // remove ssr only styles\n    ssrCleanup();\n  }\n\n  /** render dehydrated server-side */\n  async renderSsr(rootExtension: string, { assets, browser, server }: SsrContent = {}): Promise<string> {\n    const rootFactory = this.getRoot(rootExtension);\n    if (!rootFactory) throw new Error(`root: ${rootExtension} was not found`);\n\n    const uiRoot = rootFactory();\n    const routes = this.router.renderRoutes(uiRoot.routes, { initialLocation: browser?.location.url });\n    const hudItems = this.hudSlot.values();\n\n    // create array once to keep consistent indexes\n    const lifecycleHooks = this.lifecycleSlot.toArray();\n\n    // TODO - extract the logic from here down as reusable ssr machine\n    // (1) init\n    let renderContexts = await this.triggerServerInit(lifecycleHooks, browser, server);\n    const reactContexts = this.getReactContexts(lifecycleHooks, renderContexts);\n\n    // (2) make (virtual) dom\n    const app = (\n      <MountPoint>\n        <Compose components={reactContexts}>\n          <ClientContext>\n            {hudItems}\n            {routes}\n          </ClientContext>\n        </Compose>\n      </MountPoint>\n    );\n\n    // (3) render\n    renderContexts = await this.onBeforeRender(renderContexts, lifecycleHooks, app);\n\n    const renderedApp = ReactDOMServer.renderToString(app);\n\n    // (3) render html-template\n    const realtimeAssets = await this.serialize(lifecycleHooks, renderContexts, app);\n    // @ts-ignore // TODO upgrade 'webpack-merge'\n    const totalAssets = merge(assets, realtimeAssets) as Assets;\n\n    const html = <Html assets={totalAssets} withDevTools fullHeight ssr />;\n    const renderedHtml = `<!DOCTYPE html>${ReactDOMServer.renderToStaticMarkup(html)}`;\n    const fullHtml = Html.fillContent(renderedHtml, renderedApp);\n\n    // (4) serve\n    return fullHtml;\n  }\n\n  /** adds elements to the Heads Up Display */\n  registerHudItem = (element: ReactNode) => {\n    this.hudSlot.register(element);\n  };\n\n  /**\n   * adds global context at the ui root\n   * @deprecated replace with `.registerRenderHooks({ reactContext })`.\n   */\n  registerContext<T>(context: ComponentType<ContextProps<T>>) {\n    this.lifecycleSlot.register({\n      reactContext: context,\n    });\n  }\n\n  registerRoot(uiRoot: UIRootFactory) {\n    return this.uiRootSlot.register(uiRoot);\n  }\n\n  registerRenderHooks<T, Y>(hooks: RenderLifecycle<T, Y>) {\n    return this.lifecycleSlot.register(hooks);\n  }\n\n  private triggerBrowserInit(lifecycleHooks: [string, RenderLifecycle<any, any>][], deserializedState: any[]) {\n    return Promise.all(lifecycleHooks.map(([, hooks], idx) => hooks.browserInit?.(deserializedState[idx])));\n  }\n\n  private triggerServerInit(\n    lifecycleHooks: [string, RenderLifecycle<any, any>][],\n    browser?: BrowserData,\n    server?: RequestServer\n  ) {\n    return Promise.all(lifecycleHooks.map(([, hooks]) => hooks.serverInit?.({ browser, server })));\n  }\n\n  private getReactContexts(lifecycleHooks: [string, RenderLifecycle<any>][], renderContexts: any[]): Wrapper[] {\n    return compact(\n      lifecycleHooks.map(([, hooks], idx) => {\n        const renderCtx = renderContexts[idx];\n        const props = { renderCtx };\n        return hooks.reactContext ? [hooks.reactContext, props] : undefined;\n      })\n    );\n  }\n\n  private async onBeforeRender(\n    renderContexts: any[],\n    lifecycleHooks: [string, RenderLifecycle<any>][],\n    app: JSX.Element\n  ) {\n    await Promise.all(\n      lifecycleHooks.map(async ([, hooks], idx) => {\n        const ctx = renderContexts[idx];\n        const nextCtx = await hooks.onBeforeRender?.(ctx, app);\n        return nextCtx || ctx;\n      })\n    );\n    return renderContexts;\n  }\n\n  private triggerBeforeHydrateHook(\n    renderContexts: any[],\n    lifecycleHooks: [string, RenderLifecycle<any>][],\n    app: JSX.Element\n  ) {\n    return Promise.all(\n      lifecycleHooks.map(async ([, hooks], idx) => {\n        const ctx = renderContexts[idx];\n        const nextCtx = await hooks.onBeforeHydrate?.(ctx, app);\n        return nextCtx || ctx;\n      })\n    );\n  }\n\n  private async triggerHydrateHook(\n    renderContexts: any[],\n    lifecycleHooks: [string, RenderLifecycle<any, any>][],\n    mountPoint: HTMLElement | null\n  ) {\n    await Promise.all(lifecycleHooks.map(([, hooks], idx) => hooks.onHydrate?.(renderContexts[idx], mountPoint)));\n  }\n\n  private async serialize(\n    lifecycleHooks: [string, RenderLifecycle][],\n    renderContexts: any[],\n    app: ReactNode\n  ): Promise<Assets> {\n    const json = {};\n\n    await Promise.all(\n      lifecycleHooks.map(async ([key, hooks], idx) => {\n        const renderCtx = renderContexts[idx];\n        const result = await hooks.serialize?.(renderCtx, app);\n\n        if (!result) return;\n        if (result.json) json[key] = result.json;\n      })\n    );\n\n    // more assets will be available in the future\n    return { json };\n  }\n\n  private async deserialize(lifecycleHooks: [string, RenderLifecycle][]) {\n    const rawAssets = Html.popAssets();\n\n    const deserialized = await Promise.all(\n      lifecycleHooks.map(async ([key, hooks]) => {\n        try {\n          const raw = rawAssets.get(key);\n          return hooks.deserialize?.(raw);\n        } catch (e) {\n          // eslint-disable-next-line no-console\n          console.error(`failed deserializing server state for aspect ${key}`, e);\n          return undefined;\n        }\n      })\n    );\n\n    return deserialized;\n  }\n\n  private getRoot(rootExtension: string) {\n    return this.uiRootSlot.get(rootExtension);\n  }\n\n  static slots = [Slot.withType<UIRootFactory>(), Slot.withType<ReactNode>(), Slot.withType<RenderLifecycle>()];\n\n  static dependencies = [GraphqlAspect, ReactRouterAspect];\n\n  static runtime = UIRuntime;\n\n  static async provider(\n    [GraphqlUi, router]: [GraphqlUI, ReactRouterUI],\n    config,\n    [uiRootSlot, hudSlot, renderLifecycleSlot]: [UIRootRegistry, HudSlot, renderLifecycleSlot]\n  ) {\n    const uiUi = new UiUI(router, uiRootSlot, hudSlot, renderLifecycleSlot);\n\n    uiUi.registerRenderHooks(GraphqlUi.renderHooks);\n\n    return uiUi;\n  }\n}\n\nUIAspect.addRuntime(UiUI);\n"]}