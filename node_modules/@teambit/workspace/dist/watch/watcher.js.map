{"version":3,"sources":["watcher.ts"],"names":["Watcher","constructor","workspace","pubsub","trackDirs","verbose","multipleWatchers","watch","opts","Boolean","watchAll","msgs","consumer","_verbose","createWatcher","watcher","fsWatcher","onStart","Promise","resolve","reject","process","env","BIT_LOG","onAll","on","onReady","filePath","startTime","Date","getTime","buildResults","handleChange","duration","onChange","onAdd","p","onUnlink","err","onError","endsWith","BIT_MAP","handleBitmapChanges","completeWatch","componentId","getComponentIdAndClearItsCache","logger","debug","executeWatchOperationsOnComponent","msg","error","console","message","previewsTrackDirs","_reloadConsumer","setTrackDirs","newDirs","Object","keys","removedDirs","results","length","add","addResults","dir","push","flat","unwatch","executeWatchOperationsOnRemove","chalk","bold","toString","pub","WorkspaceAspect","id","creatOnComponentRemovedEvent","triggerOnComponentRemove","isChange","isComponentWatchedExternally","get","idStr","creatOnComponentChangeEvent","creatOnComponentAddEvent","triggerOnComponentChange","triggerOnComponentAdd","OnComponentRemovedEvent","now","hook","OnComponentChangeEvent","OnComponentAddEvent","loader","stop","watcherData","find","m","componentIds","isEqual","_legacy","compilerId","relativeFile","getPathRelativeToConsumer","trackDir","findTrackDirByFilePathRecursively","clearComponentCache","component","componentMap","state","_consumer","getFilesRelativeToConsumer","parentDir","pathsToWatch","getPathsToWatch","chokidar","ignoreInitial","ignored","path","includes","sep","persistent","useFsEvents","componentsFromBitMap","bitMap","getAllComponents","COMPONENT_ORIGINS","AUTHORED","IMPORTED","all","map","bitId","getTrackDir","Error","resolveComponentId","paths","pathsAbsolute","toAbsolutePath"],"mappings":"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","sourcesContent":["import { PubsubMain } from '@teambit/pubsub';\nimport { dirname, sep } from 'path';\nimport { difference } from 'lodash';\nimport { ComponentID } from '@teambit/component';\nimport { BitId } from '@teambit/legacy-bit-id';\nimport loader from '@teambit/legacy/dist/cli/loader';\nimport { BIT_MAP, COMPONENT_ORIGINS } from '@teambit/legacy/dist/constants';\nimport { Consumer } from '@teambit/legacy/dist/consumer';\nimport logger from '@teambit/legacy/dist/logger/logger';\nimport { pathNormalizeToLinux } from '@teambit/legacy/dist/utils';\nimport mapSeries from 'p-map-series';\nimport chalk from 'chalk';\nimport { ChildProcess } from 'child_process';\nimport chokidar, { FSWatcher } from 'chokidar';\nimport ComponentMap from '@teambit/legacy/dist/consumer/bit-map/component-map';\nimport { PathLinux, PathOsBasedAbsolute } from '@teambit/legacy/dist/utils/path';\nimport { WorkspaceAspect } from '../';\nimport { OnComponentChangeEvent, OnComponentAddEvent, OnComponentRemovedEvent } from '../events';\nimport { Workspace } from '../workspace';\nimport { OnComponentEventResult } from '../on-component-events';\n\nexport type WatcherProcessData = { watchProcess: ChildProcess; compilerId: BitId; componentIds: BitId[] };\n\nexport class Watcher {\n  private fsWatcher: FSWatcher;\n  constructor(\n    private workspace: Workspace,\n    private pubsub: PubsubMain,\n    private trackDirs: { [dir: PathLinux]: ComponentID } = {},\n    private verbose = false,\n    private multipleWatchers: WatcherProcessData[] = []\n  ) {}\n\n  async watch(opts: { msgs; verbose?: boolean }) {\n    this.verbose = Boolean(opts.verbose);\n    await this.watchAll({ msgs: opts.msgs, verbose: this.verbose });\n  }\n\n  get consumer(): Consumer {\n    return this.workspace.consumer;\n  }\n\n  async watchAll(opts?: { msgs; verbose?: boolean }) {\n    // TODO: run build in the beginning of process (it's work like this in other envs)\n    const _verbose = opts?.verbose || false;\n    await this.createWatcher();\n    const watcher = this.fsWatcher;\n    opts?.msgs?.onStart(this.workspace);\n\n    return new Promise((resolve, reject) => {\n      // prefix your command with \"BIT_LOG=*\" to see all watch events\n      if (process.env.BIT_LOG) {\n        if (opts?.msgs?.onAll) watcher.on('all', opts?.msgs?.onAll);\n      }\n      watcher.on('ready', () => {\n        opts?.msgs?.onReady(this.workspace, this.trackDirs, _verbose);\n      });\n      // eslint-disable-next-line @typescript-eslint/no-misused-promises\n      watcher.on('change', async (filePath) => {\n        const startTime = new Date().getTime();\n        const buildResults = (await this.handleChange(filePath)) || [];\n        const duration = new Date().getTime() - startTime;\n        opts?.msgs?.onChange(filePath, buildResults, _verbose, duration);\n      });\n      // eslint-disable-next-line @typescript-eslint/no-misused-promises\n      watcher.on('add', async (filePath) => {\n        const startTime = new Date().getTime();\n        const buildResults = (await this.handleChange(filePath)) || [];\n        const duration = new Date().getTime() - startTime;\n        opts?.msgs?.onAdd(filePath, buildResults, _verbose, duration);\n      });\n      // eslint-disable-next-line @typescript-eslint/no-misused-promises\n      watcher.on('unlink', async (p) => {\n        opts?.msgs?.onUnlink(p);\n        await this.handleChange(p);\n      });\n      watcher.on('error', (err) => {\n        opts?.msgs?.onError(err);\n        reject(err);\n      });\n    });\n  }\n\n  private async handleChange(filePath: string): Promise<OnComponentEventResult[]> {\n    try {\n      if (filePath.endsWith(BIT_MAP)) {\n        const buildResults = await this.handleBitmapChanges();\n        this.completeWatch();\n        return buildResults;\n      }\n      const componentId = await this.getComponentIdAndClearItsCache(filePath);\n      if (!componentId) {\n        logger.debug(`file ${filePath} is not part of any component, ignoring it`);\n        return this.completeWatch();\n      }\n\n      const buildResults = await this.executeWatchOperationsOnComponent(componentId);\n      this.completeWatch();\n      return buildResults;\n    } catch (err: any) {\n      const msg = `watcher found an error while handling ${filePath}`;\n      logger.error(msg, err);\n      logger.console(`${msg}, ${err.message}`);\n      return [];\n    }\n  }\n\n  /**\n   * if .bitmap has change, it's possible that a new component has added. trigger onComponentAdd.\n   */\n  private async handleBitmapChanges(): Promise<OnComponentEventResult[]> {\n    const previewsTrackDirs = { ...this.trackDirs };\n    await this.workspace._reloadConsumer();\n    await this.setTrackDirs();\n    const newDirs: string[] = difference(Object.keys(this.trackDirs), Object.keys(previewsTrackDirs));\n    const removedDirs: string[] = difference(Object.keys(previewsTrackDirs), Object.keys(this.trackDirs));\n    const results: OnComponentEventResult[] = [];\n    if (newDirs.length) {\n      this.fsWatcher.add(newDirs);\n      const addResults = await mapSeries(newDirs, (dir) =>\n        this.executeWatchOperationsOnComponent(this.trackDirs[dir], false)\n      );\n      results.push(...addResults.flat());\n    }\n    if (removedDirs.length) {\n      await this.fsWatcher.unwatch(removedDirs);\n      await mapSeries(removedDirs, (dir) => this.executeWatchOperationsOnRemove(previewsTrackDirs[dir]));\n    }\n    return results;\n  }\n\n  private async executeWatchOperationsOnRemove(componentId: ComponentID) {\n    logger.debug(`running OnComponentRemove hook for ${chalk.bold(componentId.toString())}`);\n    this.pubsub.pub(WorkspaceAspect.id, this.creatOnComponentRemovedEvent(componentId.toString()));\n    await this.workspace.triggerOnComponentRemove(componentId);\n  }\n\n  private async executeWatchOperationsOnComponent(\n    componentId: ComponentID,\n    isChange = true\n  ): Promise<OnComponentEventResult[]> {\n    if (this.isComponentWatchedExternally(componentId)) {\n      // update capsule, once done, it automatically triggers the external watcher\n      await this.workspace.get(componentId);\n      return [];\n    }\n    const idStr = componentId.toString();\n\n    if (isChange) {\n      logger.debug(`running OnComponentChange hook for ${chalk.bold(idStr)}`);\n      this.pubsub.pub(WorkspaceAspect.id, this.creatOnComponentChangeEvent(idStr, 'OnComponentChange'));\n    } else {\n      logger.debug(`running OnComponentAdd hook for ${chalk.bold(idStr)}`);\n      this.pubsub.pub(WorkspaceAspect.id, this.creatOnComponentAddEvent(idStr, 'OnComponentAdd'));\n    }\n\n    let buildResults: OnComponentEventResult[];\n    try {\n      buildResults = isChange\n        ? await this.workspace.triggerOnComponentChange(componentId)\n        : await this.workspace.triggerOnComponentAdd(componentId);\n    } catch (err: any) {\n      // do not exist the watch process on errors, just print them\n      logger.console(err.message || err);\n      return [];\n    }\n    if (buildResults && buildResults.length) {\n      return buildResults;\n    }\n    logger.console(`${idStr} doesn't have a compiler, nothing to build`);\n    return [];\n  }\n\n  private creatOnComponentRemovedEvent(idStr) {\n    return new OnComponentRemovedEvent(Date.now(), idStr);\n  }\n\n  private creatOnComponentChangeEvent(idStr, hook) {\n    return new OnComponentChangeEvent(Date.now(), idStr, hook);\n  }\n\n  private creatOnComponentAddEvent(idStr, hook) {\n    return new OnComponentAddEvent(Date.now(), idStr, hook);\n  }\n\n  private completeWatch() {\n    loader.stop();\n    return [];\n  }\n\n  private isComponentWatchedExternally(componentId: ComponentID) {\n    const watcherData = this.multipleWatchers.find((m) => m.componentIds.find((id) => id.isEqual(componentId._legacy)));\n    if (watcherData) {\n      logger.debug(`${componentId.toString()} is watched by ${watcherData.compilerId.toString()}`);\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * if a file was added/remove, once the component is loaded, it changes .bitmap, and then the\n   * entire cache is invalidated and the consumer is reloaded.\n   * when a file just changed, no need to reload the consumer, it is enough to just delete the\n   * component from the cache (both, workspace and consumer)\n   */\n  private async getComponentIdAndClearItsCache(filePath: string): Promise<ComponentID | null> {\n    const relativeFile = pathNormalizeToLinux(this.consumer.getPathRelativeToConsumer(filePath));\n    const trackDir = this.findTrackDirByFilePathRecursively(relativeFile);\n    if (!trackDir) {\n      // the file is not part of any component. If it was a new component, or a new file of\n      // existing component, then, handleBitmapChanges() should deal with it.\n      return null;\n    }\n    const componentId = this.trackDirs[trackDir];\n    this.workspace.clearComponentCache(componentId);\n    const component = await this.workspace.get(componentId);\n    const componentMap: ComponentMap = component.state._consumer.componentMap;\n    if (componentMap.getFilesRelativeToConsumer().find((p) => p === relativeFile)) {\n      return componentId;\n    }\n    // the file is inside the component dir but it's ignored. (e.g. it's in IGNORE_LIST)\n    return null;\n  }\n\n  private findTrackDirByFilePathRecursively(filePath: string): string | null {\n    if (this.trackDirs[filePath]) return filePath;\n    const parentDir = dirname(filePath);\n    if (parentDir === filePath) return null;\n    return this.findTrackDirByFilePathRecursively(parentDir);\n  }\n\n  private async createWatcher() {\n    const pathsToWatch = await this.getPathsToWatch();\n    this.fsWatcher = chokidar.watch(pathsToWatch, {\n      ignoreInitial: true,\n      // Using the function way since the regular way not working as expected\n      // It might be solved when upgrading to chokidar > 3.0.0\n      // See:\n      // https://github.com/paulmillr/chokidar/issues/773\n      // https://github.com/paulmillr/chokidar/issues/492\n      // https://github.com/paulmillr/chokidar/issues/724\n      ignored: (path) => {\n        // Ignore package.json temporarily since it cerates endless loop since it's re-written after each build\n        if (path.includes(`${sep}node_modules${sep}`) || path.includes(`${sep}package.json`)) {\n          return true;\n        }\n        return false;\n      },\n      persistent: true,\n      useFsEvents: false,\n    });\n  }\n\n  async setTrackDirs() {\n    this.trackDirs = {};\n    const componentsFromBitMap = this.consumer.bitMap.getAllComponents([\n      COMPONENT_ORIGINS.AUTHORED,\n      COMPONENT_ORIGINS.IMPORTED,\n    ]);\n    await Promise.all(\n      componentsFromBitMap.map(async (componentMap) => {\n        const bitId = componentMap.id;\n        const trackDir = componentMap.getTrackDir();\n        if (!trackDir) throw new Error(`${bitId.toString()} has no rootDir, which is invalid in Harmony`);\n        const componentId = await this.workspace.resolveComponentId(bitId);\n        this.trackDirs[trackDir] = componentId;\n      })\n    );\n  }\n\n  private async getPathsToWatch(): Promise<PathOsBasedAbsolute[]> {\n    await this.setTrackDirs();\n    const paths = [...Object.keys(this.trackDirs), BIT_MAP];\n    const pathsAbsolute = paths.map((dir) => this.consumer.toAbsolutePath(dir));\n    return pathsAbsolute;\n  }\n}\n"]}