{"version":3,"sources":["workspace.provider.ts"],"names":["provideWorkspace","pubsub","cli","scope","component","isolator","dependencyResolver","variants","loggerExt","graphql","ui","bundler","aspectLoader","envs","config","onComponentLoadSlot","onComponentChangeSlot","onComponentAddSlot","onComponentRemoveSlot","harmony","bitConfig","get","consumer","getConsumer","cwd","undefined","logger","createLogger","EXT_NAME","workspace","Workspace","getWorkspacePolicyFromPackageJson","packageJson","packageJsonObject","policyFromPackageJson","registerRootPolicy","ManyComponentsWriter","registerExternalInstaller","install","installOpts","dedupe","updateExisting","import","onCacheClear","push","clearCache","isLegacy","LegacyComponentLoader","registerOnComponentLoadSubscriber","legacyComponent","id","resolveComponentId","newComponent","state","_consumer","ConsumerComponent","registerOnComponentConfigLoading","componentId","componentFromScope","extensions","componentExtensions","defaultScope","componentDefaultScope","loadExtensions","extensionsWithLegacyIdsP","map","extension","legacyEntry","clone","extensionId","compId","_legacy","newExtensionId","extensionsWithLegacyIds","Promise","all","ExtensionDataList","fromArray","workspaceSchema","registerUiRoot","WorkspaceUIRoot","register","capsuleCmd","CapsuleCmd","commands","CapsuleListCmd","CapsuleCreateCmd","InstallCmd","EjectConfCmd","watcher","Watcher","unregister","WatchCommand","LinkCommand","Tag","registerHost","registerOnStart","loadAspects","getNotLoadedConfiguredExtensions","path"],"mappings":"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","sourcesContent":["import { PubsubMain } from '@teambit/pubsub';\nimport type { AspectLoaderMain } from '@teambit/aspect-loader';\nimport { BundlerMain } from '@teambit/bundler';\nimport { CLIMain, CommandList } from '@teambit/cli';\nimport { ComponentMain } from '@teambit/component';\nimport { DependencyResolverMain } from '@teambit/dependency-resolver';\nimport { EnvsMain } from '@teambit/envs';\nimport { GraphqlMain } from '@teambit/graphql';\nimport { Harmony, SlotRegistry } from '@teambit/harmony';\nimport { IsolatorMain } from '@teambit/isolator';\nimport { LoggerMain } from '@teambit/logger';\nimport type { ScopeMain } from '@teambit/scope';\nimport { UiMain } from '@teambit/ui';\nimport type { VariantsMain } from '@teambit/variants';\nimport { Consumer, loadConsumerIfExist } from '@teambit/legacy/dist/consumer';\nimport ConsumerComponent from '@teambit/legacy/dist/consumer/component';\nimport { registerDefaultScopeGetter } from '@teambit/legacy/dist/api/consumer';\nimport { BitId } from '@teambit/legacy-bit-id';\nimport ManyComponentsWriter from '@teambit/legacy/dist/consumer/component-ops/many-components-writer';\nimport LegacyComponentLoader from '@teambit/legacy/dist/consumer/component/component-loader';\nimport { ExtensionDataList } from '@teambit/legacy/dist/consumer/config/extension-data';\nimport { EXT_NAME } from './constants';\nimport EjectConfCmd from './eject-conf.cmd';\nimport InstallCmd from './install.cmd';\nimport { OnComponentLoad, OnComponentAdd, OnComponentChange, OnComponentRemove } from './on-component-events';\nimport { WorkspaceExtConfig } from './types';\nimport { WatchCommand } from './watch/watch.cmd';\nimport { LinkCommand } from './link';\nimport { Watcher } from './watch/watcher';\nimport { Workspace, WorkspaceInstallOptions } from './workspace';\nimport getWorkspaceSchema from './workspace.graphql';\nimport { WorkspaceUIRoot } from './workspace.ui-root';\nimport { Tag } from './tag-cmd';\nimport { CapsuleCmd, CapsuleCreateCmd, CapsuleListCmd } from './capsule.cmd';\n\nexport type WorkspaceDeps = [\n  PubsubMain,\n  CLIMain,\n  ScopeMain,\n  ComponentMain,\n  IsolatorMain,\n  DependencyResolverMain,\n  VariantsMain,\n  LoggerMain,\n  GraphqlMain,\n  UiMain,\n  BundlerMain,\n  AspectLoaderMain,\n  EnvsMain\n];\n\nexport type OnComponentLoadSlot = SlotRegistry<OnComponentLoad>;\n\nexport type OnComponentChangeSlot = SlotRegistry<OnComponentChange>;\n\nexport type OnComponentAddSlot = SlotRegistry<OnComponentAdd>;\n\nexport type OnComponentRemoveSlot = SlotRegistry<OnComponentRemove>;\n\nexport default async function provideWorkspace(\n  [\n    pubsub,\n    cli,\n    scope,\n    component,\n    isolator,\n    dependencyResolver,\n    variants,\n    loggerExt,\n    graphql,\n    ui,\n    bundler,\n    aspectLoader,\n    envs,\n  ]: WorkspaceDeps,\n  config: WorkspaceExtConfig,\n  [onComponentLoadSlot, onComponentChangeSlot, onComponentAddSlot, onComponentRemoveSlot]: [\n    OnComponentLoadSlot,\n    OnComponentChangeSlot,\n    OnComponentAddSlot,\n    OnComponentRemoveSlot\n  ],\n  harmony: Harmony\n) {\n  const bitConfig: any = harmony.config.get('teambit.harmony/bit');\n  const consumer = await getConsumer(bitConfig.cwd);\n  if (!consumer) return undefined;\n  // TODO: get the 'workspace' name in a better way\n  const logger = loggerExt.createLogger(EXT_NAME);\n  const workspace = new Workspace(\n    pubsub,\n    config,\n    consumer,\n    scope,\n    component,\n    isolator,\n    dependencyResolver,\n    variants,\n    aspectLoader,\n    logger,\n    undefined,\n    harmony,\n    onComponentLoadSlot,\n    onComponentChangeSlot,\n    envs,\n    onComponentAddSlot,\n    onComponentRemoveSlot,\n    graphql\n  );\n\n  const getWorkspacePolicyFromPackageJson = () => {\n    const packageJson = workspace.consumer.packageJson?.packageJsonObject || {};\n    const policyFromPackageJson = dependencyResolver.getWorkspacePolicyFromPackageJson(packageJson);\n    return policyFromPackageJson;\n  };\n\n  dependencyResolver.registerRootPolicy(getWorkspacePolicyFromPackageJson());\n\n  ManyComponentsWriter.registerExternalInstaller({\n    install: async () => {\n      // TODO: think how we should pass this options\n      const installOpts: WorkspaceInstallOptions = {\n        dedupe: true,\n        updateExisting: false,\n        import: false,\n      };\n      return workspace.install(undefined, installOpts);\n    },\n  });\n\n  consumer.onCacheClear.push(() => workspace.clearCache());\n\n  if (!workspace.isLegacy) {\n    LegacyComponentLoader.registerOnComponentLoadSubscriber(async (legacyComponent: ConsumerComponent) => {\n      const id = await workspace.resolveComponentId(legacyComponent.id);\n      const newComponent = await workspace.get(id, false, legacyComponent);\n      return newComponent.state._consumer;\n    });\n  }\n\n  ConsumerComponent.registerOnComponentConfigLoading(EXT_NAME, async (id) => {\n    const componentId = await workspace.resolveComponentId(id);\n    // We call here directly workspace.scope.get instead of workspace.get because part of the workspace get is loading consumer component\n    // which in turn run this event, which will make an infinite loop\n    // This component from scope here are only used for merging the extensions with the workspace components\n    const componentFromScope = await workspace.scope.get(componentId);\n    const extensions = await workspace.componentExtensions(componentId, componentFromScope);\n    const defaultScope = await workspace.componentDefaultScope(componentId);\n\n    await workspace.loadExtensions(extensions);\n    const extensionsWithLegacyIdsP = extensions.map(async (extension) => {\n      const legacyEntry = extension.clone();\n      if (legacyEntry.extensionId) {\n        const compId = await workspace.resolveComponentId(legacyEntry.extensionId);\n        legacyEntry.extensionId = compId._legacy;\n        legacyEntry.newExtensionId = compId;\n      }\n\n      return legacyEntry;\n    });\n    const extensionsWithLegacyIds = await Promise.all(extensionsWithLegacyIdsP);\n\n    return {\n      defaultScope,\n      extensions: ExtensionDataList.fromArray(extensionsWithLegacyIds),\n    };\n  });\n\n  /**\n   * Add default scope from harmony during export.\n   */\n  registerDefaultScopeGetter(async (id: BitId) => {\n    const componentId = await workspace.resolveComponentId(id);\n    const defaultScope = await workspace.componentDefaultScope(componentId);\n    return defaultScope;\n  });\n\n  const workspaceSchema = getWorkspaceSchema(workspace, graphql);\n  ui.registerUiRoot(new WorkspaceUIRoot(workspace, bundler));\n  graphql.register(workspaceSchema);\n  const capsuleCmd = new CapsuleCmd();\n  capsuleCmd.commands = [new CapsuleListCmd(isolator, workspace), new CapsuleCreateCmd(workspace, isolator)];\n  const commands: CommandList = [new InstallCmd(workspace, logger), new EjectConfCmd(workspace), capsuleCmd];\n  const watcher = new Watcher(workspace, pubsub);\n  if (workspace && !workspace.consumer.isLegacy) {\n    cli.unregister('watch');\n    commands.push(new WatchCommand(pubsub, logger, watcher));\n    cli.unregister('link');\n    commands.push(new LinkCommand(workspace, logger));\n  }\n  commands.push(new Tag());\n  cli.register(...commands);\n  component.registerHost(workspace);\n\n  cli.registerOnStart(async () => {\n    await workspace.loadAspects(aspectLoader.getNotLoadedConfiguredExtensions());\n  });\n\n  return workspace;\n}\n\n/**\n * don't use loadConsumer() here, which throws ConsumerNotFound because some commands don't require\n * the consumer to be available. such as, `bit init` or `bit list --remote`.\n * most of the commands do need the consumer. the legacy commands that need the consumer throw an\n * error when is missing. in the new/Harmony commands, such as `bis compile`, the workspace object\n * is passed to the provider, so before using it, make sure it exists.\n * keep in mind that you can't verify it in the provider itself, because the provider is running\n * always for all commands before anything else is happening.\n */\nasync function getConsumer(path?: string): Promise<Consumer | undefined> {\n  return loadConsumerIfExist(path);\n}\n"]}